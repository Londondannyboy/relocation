---
import { sql } from '../../lib/db';

// Fetch all published articles with featured images and videos
const articles = await sql`
  SELECT
    a.id,
    a.title,
    a.meta_description as excerpt,
    a.slug,
    a.published_at,
    a.created_at,
    a.featured_asset_url,
    a.featured_asset_alt,
    a.video_url,
    a.video_playback_id
  FROM articles a
  WHERE a.app = 'relocation'
    AND a.status = 'published'
  ORDER BY a.published_at DESC NULLS LAST, a.created_at DESC
`;

// Video playback IDs are now stored directly in the database (video-first architecture)
articles.forEach((article: any) => {
  article.mux_playback_id = article.video_playback_id || null;
});
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>All Articles - Relocation Quest</title>
  <!-- Tailwind provided by @astrojs/tailwind integration -->
</head>
<body class="bg-gray-50">
  <!-- Navigation -->
  <nav class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center">
          <h1 class="text-2xl font-bold text-blue-600">
            <a href="/">Relocation</a>
          </h1>
        </div>
        <div class="flex items-center space-x-8">
          <a href="/" class="text-gray-700 hover:text-blue-600 font-medium">Home</a>
          <a href="/articles" class="text-gray-700 hover:text-blue-600 font-medium">Articles</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Articles Header -->
  <section class="bg-white py-12 border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <h1 class="text-4xl font-bold text-gray-900 mb-2">All Articles</h1>
      <p class="text-lg text-gray-600">Browse our complete collection of industry insights and news</p>
    </div>
  </section>

  <!-- Articles Grid -->
  <section class="py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 30px; max-width: 1200px; margin: 0 auto;">
        {articles.map((article: any) => (
          <a href={`/${article.slug}`} style="text-decoration: none; color: inherit; display: block; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 4px 16px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
            {article.mux_playback_id ? (
              <img src={`https://image.mux.com/${article.mux_playback_id}/animated.webp?width=600&fps=24`} alt={article.title} style="width: 100%; height: 220px; object-fit: cover;" />
            ) : article.featured_asset_url && (
              <img src={article.featured_asset_url} alt={article.featured_asset_alt || article.title} style="width: 100%; height: 220px; object-fit: cover;" />
            )}
            <div style="padding: 24px;">
              <h3 style="font-size: 20px; font-weight: 700; color: #1a1a1a; margin: 0 0 12px 0; line-height: 1.3;">
                {article.title}
              </h3>
              {article.excerpt && (
                <p style="color: #666; margin: 0 0 16px 0; line-height: 1.6; font-size: 15px;">
                  {article.excerpt}
                </p>
              )}
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: #999; font-size: 14px;">
                  {new Date(article.published_at || article.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                </span>
                <span style="color: #667eea; font-weight: 600; font-size: 14px;">
                  Read more →
                </span>
              </div>
            </div>
          </a>
        ))}
      </div>

      {articles.length === 0 && (
        <div style="text-center; padding: 48px 0;">
          <p style="color: #666; font-size: 18px;">No articles published yet. Check back soon!</p>
        </div>
      )}
    </div>
  </section>

  <!-- Footer -->
  <footer class="bg-gray-900 text-white py-12 mt-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <p class="text-gray-400">© {new Date().getFullYear()} Relocation. All rights reserved.</p>
    </div>
  </footer>
</body>
</html>
