---
/**
 * Country Guides Index - Premium Dark Design
 * ==========================================
 * Sophisticated magazine-style layout
 */
import { sql } from '../../lib/db';

const countriesResult = await sql`
  SELECT
    c.id, c.name, c.slug, c.code, c.flag_emoji, c.region, c.continent,
    c.relocation_motivations, c.relocation_tags, c.facts,
    h.video_playback_id as hub_video, h.slug as hub_slug, h.title as hub_title
  FROM countries c
  LEFT JOIN country_hubs h ON h.country_code = c.code AND h.status = 'published'
  WHERE c.status = 'published'
  ORDER BY c.name ASC
`;

const countries = countriesResult || [];
const featuredCountry = countries.find((c: any) => c.hub_video);

const tickerResult = await sql`
  SELECT slug, title, published_at, article_mode, country_code
  FROM articles WHERE app = 'relocation' AND published_at IS NOT NULL
  ORDER BY published_at DESC LIMIT 20
`;
const tickerArticles = tickerResult || [];

// Group by region
const regionGroups: Record<string, typeof countries> = {};
for (const country of countries) {
  const region = country.region || 'Other';
  if (!regionGroups[region]) regionGroups[region] = [];
  regionGroups[region].push(country);
}

const regionIcons: Record<string, string> = {
  'Europe': 'ğŸ°', 'Southeast Asia': 'ğŸï¸', 'Middle East': 'ğŸ•Œ',
  'East Asia': 'ğŸ—¾', 'Oceania': 'ğŸ¦˜', 'North America': 'ğŸ—½',
  'Central America': 'ğŸŒº', 'South America': 'ğŸŒ', 'Other': 'ğŸŒ',
};

const motivationConfig: Record<string, { icon: string; gradient: string }> = {
  'corporate': { icon: 'ğŸ’¼', gradient: 'from-blue-500 to-indigo-600' },
  'trust': { icon: 'ğŸ›¡ï¸', gradient: 'from-purple-500 to-violet-600' },
  'wealth': { icon: 'ğŸ’', gradient: 'from-emerald-500 to-teal-600' },
  'retirement': { icon: 'ğŸŒ…', gradient: 'from-orange-500 to-amber-600' },
  'digital-nomad': { icon: 'ğŸ’»', gradient: 'from-cyan-500 to-blue-600' },
  'lifestyle': { icon: 'ğŸŒ´', gradient: 'from-pink-500 to-rose-600' },
  'new-start': { icon: 'ğŸš€', gradient: 'from-amber-500 to-orange-600' },
  'family': { icon: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦', gradient: 'from-rose-500 to-pink-600' },
};

function getMuxThumbnail(id: string, time: number = 5) {
  return id ? "https://image.mux.com/" + id + "/thumbnail.jpg?time=" + time + "&width=800" : '';
}
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Country Relocation Guides - Relocation Quest</title>
  <meta name="description" content="Comprehensive relocation guides for countries around the world.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@mux/mux-player"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background: #0a0a0a; }
    .card-3d { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    .card-3d:hover { transform: translateY(-8px) scale(1.02); }
    .glow { box-shadow: 0 0 60px -15px rgba(245, 158, 11, 0.3); }
    .glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
    .gradient-text { background: linear-gradient(135deg, #f59e0b 0%, #ec4899 50%, #8b5cf6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .grid-pattern { background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px); background-size: 50px 50px; }
    .ticker-wrapper { overflow: hidden; }
    .ticker-track { display: flex; animation: ticker-scroll 60s linear infinite; }
    .ticker-track:hover { animation-play-state: paused; }
    @keyframes ticker-scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
  </style>
</head>

<body class="text-white">
  <!-- Background Effects -->
  <div class="fixed inset-0 grid-pattern pointer-events-none"></div>
  <div class="fixed top-0 left-1/4 w-96 h-96 bg-amber-500/10 rounded-full blur-3xl pointer-events-none"></div>
  <div class="fixed bottom-0 right-1/4 w-96 h-96 bg-purple-500/10 rounded-full blur-3xl pointer-events-none"></div>

  <!-- Navigation -->
  <nav class="fixed top-0 left-0 right-0 z-50 glass">
    <div class="max-w-7xl mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <a href="/" class="text-xl font-bold">
          <span class="text-white">Relocation</span><span class="text-amber-500">Quest</span>
        </a>
        <div class="flex items-center space-x-8">
          <a href="/" class="text-gray-400 hover:text-white transition-colors">Home</a>
          <a href="/guides" class="text-amber-500 font-semibold">Guides</a>
          <a href="/articles" class="text-gray-400 hover:text-white transition-colors">Articles</a>
          <a href="/voice" class="text-gray-400 hover:text-white transition-colors" style="background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Voice Assistant</a>
          <a href="/handler/sign-in" class="px-4 py-2 rounded-full text-white text-sm font-semibold" style="background: linear-gradient(135deg, #667eea, #764ba2);">Sign In</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Hero -->
  <header class="relative min-h-screen flex items-center pt-20">
    {featuredCountry?.hub_video ? (
      <div class="absolute inset-0 overflow-hidden">
        <mux-player
          playback-id={featuredCountry.hub_video}
          autoplay="muted"
          loop
          class="w-full h-full object-cover opacity-40"
          style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); min-width: 100%; min-height: 100%;"
        />
        <div class="absolute inset-0 bg-gradient-to-t from-[#0a0a0a] via-[#0a0a0a]/60 to-transparent"></div>
        <div class="absolute inset-0 bg-gradient-to-r from-[#0a0a0a] via-transparent to-[#0a0a0a]/80"></div>
      </div>
    ) : null}

    <div class="relative z-10 max-w-7xl mx-auto px-6 py-20">
      <div class="max-w-4xl">
        <div class="flex items-center gap-4 mb-6">
          <span class="glass px-4 py-2 rounded-full text-sm font-medium text-amber-400">
            ğŸŒ {countries.length} Countries
          </span>
          <span class="glass px-4 py-2 rounded-full text-sm font-medium text-purple-400">
            ğŸ¬ {countries.filter((c: any) => c.hub_video).length} Video Guides
          </span>
        </div>

        <h1 class="text-6xl md:text-8xl font-black mb-6 leading-none">
          <span class="gradient-text">Your New</span>
          <br />
          <span class="text-white">Chapter</span>
        </h1>

        <p class="text-xl text-gray-400 mb-10 max-w-2xl leading-relaxed">
          Comprehensive guides for relocating abroad â€” visa options, tax planning, cost of living, and insider knowledge.
        </p>

        {featuredCountry && (
          <a href={featuredCountry.hub_slug ? "/hubs/" + featuredCountry.hub_slug : "/guides/" + featuredCountry.slug}
             class="group inline-flex items-center gap-4 glass px-8 py-4 rounded-2xl hover:bg-white/10 transition-all glow">
            <span class="text-4xl">{featuredCountry.flag_emoji}</span>
            <div class="flex-1">
              <p class="text-xs text-amber-400 font-semibold uppercase tracking-wider mb-1">Featured Guide</p>
              <p class="text-white font-bold">{featuredCountry.name}</p>
            </div>
            <span class="text-2xl group-hover:translate-x-2 transition-transform">â†’</span>
          </a>
        )}
      </div>
    </div>
  </header>

  <!-- Ticker -->
  {tickerArticles.length > 0 && (
    <div class="ticker-wrapper py-3 border-t border-b border-white/10">
      <div class="ticker-track">
        {[...tickerArticles, ...tickerArticles].map((article: any) => (
          <a href={"/" + article.slug} class="flex-shrink-0 px-8 text-gray-400 hover:text-amber-400 transition-colors text-sm whitespace-nowrap">
            <span class="text-amber-500 mr-2">
              {article.article_mode === 'story' ? 'ğŸ“–' : article.article_mode === 'guide' ? 'ğŸ“‹' : article.article_mode === 'yolo' ? 'ğŸš€' : 'ğŸ’¬'}
            </span>
            {article.title}
          </a>
        ))}
      </div>
    </div>
  )}

  <!-- Stats -->
  <section class="relative z-10 py-8 border-b border-white/10">
    <div class="max-w-7xl mx-auto px-6">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
        {[
          { value: countries.length, label: 'Countries', icon: 'ğŸŒ' },
          { value: countries.filter((c: any) => c.hub_video).length, label: 'Video Guides', icon: 'ğŸ¬' },
          { value: Object.keys(regionGroups).length, label: 'Regions', icon: 'ğŸ—ºï¸' },
          { value: 8, label: 'Visa Types', icon: 'ğŸ“‹' },
        ].map((stat) => (
          <div class="text-center">
            <div class="text-4xl font-black gradient-text">{stat.value}</div>
            <div class="text-gray-500 text-sm mt-1">{stat.icon} {stat.label}</div>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Motivation Filter -->
  <section class="sticky top-16 z-40 py-4 glass border-b border-white/10">
    <div class="max-w-7xl mx-auto px-6">
      <div class="flex items-center gap-3 overflow-x-auto">
        <span class="text-gray-500 text-sm whitespace-nowrap">By motivation:</span>
        {Object.entries(motivationConfig).map(([key, config]) => (
          <button class={"px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap flex items-center gap-2 bg-gradient-to-r " + config.gradient + " hover:opacity-90 transition-opacity"}>
            {config.icon} {key.charAt(0).toUpperCase() + key.slice(1).replace('-', ' ')}
          </button>
        ))}
      </div>
    </div>
  </section>

  <!-- Countries by Region -->
  <main class="relative z-10 max-w-7xl mx-auto px-6 py-16">
    {Object.entries(regionGroups).map(([region, regionCountries]) => (
      <section class="mb-20">
        <div class="flex items-center gap-4 mb-10">
          <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center text-2xl">
            {regionIcons[region] || 'ğŸŒ'}
          </div>
          <div>
            <h2 class="text-3xl font-bold text-white">{region}</h2>
            <p class="text-gray-500">{regionCountries.length} {regionCountries.length === 1 ? 'country' : 'countries'}</p>
          </div>
        </div>

        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {regionCountries.map((country: any) => {
            const facts = typeof country.facts === 'string' ? JSON.parse(country.facts) : country.facts || {};
            const motivations = country.relocation_motivations || [];
            const hasVideo = !!country.hub_video;

            return (
              <a href={country.hub_slug ? "/hubs/" + country.hub_slug : "/guides/" + country.slug} class="card-3d group">
                <div class="glass rounded-2xl overflow-hidden h-full">
                  {hasVideo ? (
                    <div class="relative aspect-video">
                      <img src={getMuxThumbnail(country.hub_video, 5)} alt={country.name} class="w-full h-full object-cover" />
                      <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent"></div>
                      <div class="absolute bottom-4 left-4 flex items-center gap-3">
                        <span class="text-4xl">{country.flag_emoji || 'ğŸŒ'}</span>
                        <div>
                          <h3 class="text-xl font-bold text-white">{country.name}</h3>
                          <p class="text-gray-300 text-sm">{country.region}</p>
                        </div>
                      </div>
                      <div class="absolute top-3 right-3 bg-amber-500 text-white text-xs px-3 py-1 rounded-full font-semibold flex items-center gap-1">
                        â–¶ Video Guide
                      </div>
                      <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all">
                        <div class="w-16 h-16 rounded-full bg-white/90 flex items-center justify-center">
                          <span class="text-2xl text-gray-900 ml-1">â–¶</span>
                        </div>
                      </div>
                    </div>
                  ) : (
                    <div class="bg-gradient-to-br from-gray-800 to-gray-900 p-6 aspect-video flex items-center">
                      <div class="flex items-center gap-4">
                        <span class="text-5xl">{country.flag_emoji || 'ğŸŒ'}</span>
                        <div>
                          <h3 class="text-xl font-bold text-white">{country.name}</h3>
                          <p class="text-gray-400 text-sm">{country.region}</p>
                        </div>
                      </div>
                    </div>
                  )}

                  <div class="p-6">
                    {motivations.length > 0 && (
                      <div class="flex flex-wrap gap-2 mb-4">
                        {motivations.slice(0, 3).map((mot: string) => {
                          const config = motivationConfig[mot] || { icon: 'ğŸ“', gradient: 'from-gray-500 to-gray-600' };
                          return (
                            <span class={"px-2 py-1 rounded-lg text-xs font-medium bg-gradient-to-r text-white " + config.gradient}>
                              {config.icon}
                            </span>
                          );
                        })}
                      </div>
                    )}

                    <div class="space-y-2 text-sm">
                      {facts.corporate_tax_rate && (
                        <div class="flex justify-between">
                          <span class="text-gray-500">ğŸ’¼ Corporate Tax</span>
                          <span class="text-white font-semibold">{facts.corporate_tax_rate}</span>
                        </div>
                      )}
                      {facts.cost_of_living_single && (
                        <div class="flex justify-between">
                          <span class="text-gray-500">ğŸ  Cost of Living</span>
                          <span class="text-white font-semibold">{facts.cost_of_living_single}</span>
                        </div>
                      )}
                    </div>

                    <div class="mt-6 pt-4 border-t border-white/10 flex items-center justify-between">
                      <span class="text-amber-500 font-semibold group-hover:text-amber-400 transition-colors">
                        {hasVideo ? 'Watch Guide' : 'Explore'}
                      </span>
                      <span class="text-amber-500 group-hover:translate-x-1 transition-transform">â†’</span>
                    </div>
                  </div>
                </div>
              </a>
            );
          })}
        </div>
      </section>
    ))}
  </main>

  <!-- CTA -->
  <section class="relative z-10 py-20 border-t border-white/10">
    <div class="max-w-4xl mx-auto px-6 text-center">
      <h2 class="text-4xl md:text-5xl font-black mb-6">
        <span class="gradient-text">Ready to Move?</span>
      </h2>
      <p class="text-xl text-gray-400 mb-10">
        Get personalized guidance for your relocation journey.
      </p>
      <a href="/articles" class="inline-flex items-center gap-3 bg-gradient-to-r from-amber-500 to-orange-600 px-8 py-4 rounded-full font-bold text-lg hover:opacity-90 transition-opacity glow">
        Read Expert Articles <span class="text-2xl">â†’</span>
      </a>
    </div>
  </section>

  <!-- Footer -->
  <footer class="relative z-10 border-t border-white/10 py-12">
    <div class="max-w-7xl mx-auto px-6">
      <div class="flex flex-wrap justify-between items-center">
        <p class="text-xl font-bold">Relocation<span class="text-amber-500">Quest</span></p>
        <div class="flex gap-8">
          <a href="/guides" class="text-gray-500 hover:text-white transition-colors">Guides</a>
          <a href="/articles" class="text-gray-500 hover:text-white transition-colors">Articles</a>
          <a href="/companies" class="text-gray-500 hover:text-white transition-colors">Companies</a>
        </div>
      </div>
      <div class="mt-8 pt-8 border-t border-white/10 text-center text-gray-600 text-sm">
        Â© {new Date().getFullYear()} Relocation Quest
      </div>
    </div>
  </footer>
</body>
</html>
