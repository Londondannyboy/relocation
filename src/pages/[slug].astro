---
/**
 * Relocation Quest Article Template
 * =================================
 *
 * DATA SOURCE: Neon PostgreSQL (articles table, app='relocation')
 * GENERATED BY: content-worker ArticleCreationWorkflow
 *
 * REQUIRED NEON FIELDS:
 * - video_playback_id: Mux playback ID
 * - video_narrative: JSON with acts {act_1: {start, end, title}, ...}
 * - payload: JSON with four_act_content, faq, callouts, comparison, timeline, stat_highlight, sources
 * - content: HTML article body
 * - meta_description: SEO excerpt
 *
 * 4-ACT FRAMEWORK:
 * - 12 seconds total = 4 acts √ó 3 seconds each
 * - Act timestamps: 0-3s, 3-6s, 6-9s, 9-12s
 * - Each section gets a bounded animated GIF from its act
 *
 * MUX ANIMATED GIFS:
 * - Use animated.gif endpoint with start/end params for bounded loops
 * - Max width: 640px (larger fails)
 * - Format: https://image.mux.com/{playbackId}/animated.gif?start=0&end=3&width=640&fps=15
 *
 * ARTICLE TYPES (from content-worker):
 * - transformation: Visa guides, moving abroad (Cyprus DN Visa)
 * - country_guide: Living in X, city guides
 * - comparison: X vs Y comparisons
 * - listicle: Top 10 lists
 *
 * See: quest/content-worker/src/config/app_config.py for full documentation
 */
import { sql } from '../lib/db';

const { slug } = Astro.params;

// Prevent CDN caching - always fetch fresh from Neon
Astro.response.headers.set('Cache-Control', 'no-cache, no-store, must-revalidate');
Astro.response.headers.set('Pragma', 'no-cache');
Astro.response.headers.set('Expires', '0');

if (!slug) {
  return Astro.redirect('/');
}

// Fetch the article with 4-act structured data + content modes + cluster architecture
const articleResult = await sql`
  SELECT
    a.id,
    a.title,
    a.content,
    a.content_story,
    a.content_guide,
    a.content_yolo,
    a.content_voices,
    a.meta_description as excerpt,
    a.slug,
    a.published_at,
    a.created_at,
    a.article_angle,
    a.word_count,
    a.video_url,
    a.video_playback_id,
    a.featured_asset_url,
    a.hero_asset_url,
    a.video_narrative,
    a.payload,
    a.cluster_id,
    a.parent_id,
    a.article_mode
  FROM articles a
  WHERE a.slug = ${slug}
    AND a.app = 'relocation'
  LIMIT 1
`;

const article = articleResult[0];

if (!article) {
  return Astro.redirect('/');
}

// Fetch cluster siblings if this article is part of a cluster
let clusterArticles: any[] = [];
if (article.cluster_id) {
  const clusterResult = await sql`
    SELECT
      slug,
      title,
      article_mode,
      video_playback_id,
      parent_id
    FROM articles
    WHERE cluster_id = ${article.cluster_id}
      AND app = 'relocation'
      AND published_at IS NOT NULL
    ORDER BY
      CASE article_mode
        WHEN 'story' THEN 1
        WHEN 'guide' THEN 2
        WHEN 'yolo' THEN 3
        WHEN 'voices' THEN 4
        ELSE 5
      END
  `;
  clusterArticles = clusterResult || [];
}

// Check if this is a child article (has parent_id) - these render as regular articles
const isChildArticle = article.parent_id !== null;

// Check if using cluster architecture (separate articles per mode) vs legacy (single article with content columns)
// Child articles should NOT trigger cluster mode - they render like regular articles
const isClusterMode = !isChildArticle && article.cluster_id && clusterArticles.length > 1;
const currentMode = article.article_mode || 'story';

// Fetch related articles
const relatedResult = await sql`
  SELECT slug, title, meta_description, video_playback_id, article_angle
  FROM articles
  WHERE app = 'relocation'
    AND slug != ${slug}
    AND published_at IS NOT NULL
  ORDER BY created_at DESC
  LIMIT 3
`;
const relatedArticles = relatedResult || [];

// Parse video_narrative (4-act video data)
let videoData: any = null;
try {
  videoData = typeof article.video_narrative === 'string'
    ? JSON.parse(article.video_narrative)
    : article.video_narrative;
} catch (e) {
  console.error('Failed to parse video_narrative:', e);
}

// Parse payload for structured content (sections, FAQ, callouts, etc.)
let fourActContent: any[] = [];
let faq: any[] = [];
let callouts: any[] = [];
let statHighlight: any = null;
let comparison: any = null;
let timeline: any[] = [];
let sources: any[] = [];

try {
  const payload = typeof article.payload === 'string'
    ? JSON.parse(article.payload)
    : article.payload;
  if (payload) {
    fourActContent = payload.four_act_content || payload.sections || [];
    faq = payload.faq || [];
    callouts = payload.callouts || [];
    statHighlight = payload.stat_highlight || null;
    comparison = payload.comparison || null;
    timeline = payload.timeline || [];
    sources = payload.sources || [];
  }
} catch (e) {
  console.error('Failed to parse payload:', e);
}

// Get playback ID from video_narrative or direct field
const playbackId = videoData?.playback_id || article.video_playback_id;

// Act timestamps for bounded video loops
const actTimestamps = [
  { start: 0, end: 3, mid: 1.5, label: 'Act 1' },
  { start: 3, end: 6, mid: 4.5, label: 'Act 2' },
  { start: 6, end: 9, mid: 7.5, label: 'Act 3' },
  { start: 9, end: 12, mid: 10.5, label: 'Act 4' }
];

// Helper to get Mux thumbnail URL
function getMuxThumbnail(time: number, width: number = 800) {
  if (!playbackId) return '';
  return `https://image.mux.com/${playbackId}/thumbnail.jpg?time=${time}&width=${width}`;
}

// Helper to get Mux stream URL
function getMuxStream() {
  if (!playbackId) return '';
  return `https://stream.mux.com/${playbackId}.m3u8`;
}

// Country flag emoji mapping
const countryFlags: Record<string, string> = {
  'cyprus': 'üá®üáæ', 'portugal': 'üáµüáπ', 'spain': 'üá™üá∏', 'greece': 'üá¨üá∑',
  'italy': 'üáÆüáπ', 'malta': 'üá≤üáπ', 'croatia': 'üá≠üá∑', 'estonia': 'üá™üá™',
  'germany': 'üá©üá™', 'france': 'üá´üá∑', 'netherlands': 'üá≥üá±', 'uk': 'üá¨üáß',
  'uae': 'üá¶üá™', 'dubai': 'üá¶üá™', 'singapore': 'üá∏üá¨', 'usa': 'üá∫üá∏',
  'canada': 'üá®üá¶', 'australia': 'üá¶üá∫', 'thailand': 'üáπüá≠', 'indonesia': 'üáÆüá©',
  'mexico': 'üá≤üáΩ', 'costa rica': 'üá®üá∑', 'brazil': 'üáßüá∑'
};

function getCountryFlag(name: string): string {
  const lower = name.toLowerCase();
  for (const [country, flag] of Object.entries(countryFlags)) {
    if (lower.includes(country)) return flag;
  }
  return 'üåç';
}

// Split content by H2 headers to match with fourActContent sections
function splitContentBySections(html: string): string[] {
  if (!html) return [];
  const sections = html.split(/<h2[^>]*>/i);
  return sections.map((s, i) => {
    if (i === 0) return s;
    return '<h2>' + s;
  }).filter(s => s.trim());
}

const contentSections = splitContentBySections(article.content || '');

// Helper to strip script tags from content (JSON-LD etc. breaks set:html)
function stripScriptTags(html: string): string {
  if (!html) return '';
  // Simpler regex that handles multiline script content
  return html.replace(/<script\b[^>]*>[\s\S]*?<\/script>/gi, '');
}

// Content modes for country guides (Story/Guide/YOLO)
// Support both legacy (single article with multiple content columns) and cluster (separate articles)
// Child articles should NOT trigger mode features - they render as regular articles
const hasLegacyContentModes = !isChildArticle && !!(article.content_story || article.content_guide || article.content_yolo);
const hasContentModes = hasLegacyContentModes || isClusterMode;

// For cluster mode, use the main content field; for legacy, use content_* columns
const contentModes = {
  story: stripScriptTags(isClusterMode && currentMode === 'story' ? article.content : (article.content_story || article.content || '')),
  guide: stripScriptTags(isClusterMode && currentMode === 'guide' ? article.content : (article.content_guide || '')),
  yolo: stripScriptTags(isClusterMode && currentMode === 'yolo' ? article.content : (article.content_yolo || ''))
};

// For cluster mode, the active content is always in article.content
const activeContent = isClusterMode ? stripScriptTags(article.content || '') : contentModes.story;

// Mode display labels and icons
const modeConfig: Record<string, { label: string; icon: string; color: string }> = {
  story: { label: 'Story', icon: 'üìñ', color: 'amber' },
  guide: { label: 'Guide', icon: 'üìã', color: 'blue' },
  yolo: { label: 'YOLO', icon: 'üöÄ', color: 'pink' },
  voices: { label: 'Voices', icon: 'üéôÔ∏è', color: 'purple' }
};

// Debug: Log content mode info at build time
console.log(`[BUILD] Article: ${slug} | Mode: ${currentMode} | Child: ${isChildArticle} | Cluster: ${isClusterMode} | Cluster articles: ${clusterArticles.length}`);

// Parse voices for testimonials
let voices: any[] = [];
try {
  voices = typeof article.content_voices === 'string'
    ? JSON.parse(article.content_voices)
    : (article.content_voices || []);
} catch (e) {
  console.error('Failed to parse voices:', e);
}

// Clean up excerpt
let excerpt = article.excerpt || '';
if (excerpt && !excerpt.endsWith('.') && !excerpt.endsWith('!') && !excerpt.endsWith('?')) {
  const lastSentence = Math.max(excerpt.lastIndexOf('.'), excerpt.lastIndexOf('?'), excerpt.lastIndexOf('!'));
  if (lastSentence > excerpt.length * 0.5) {
    excerpt = excerpt.substring(0, lastSentence + 1);
  } else {
    excerpt = excerpt.trim() + '...';
  }
}
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{article.title} - Relocation Quest</title>
  <meta name="description" content={excerpt || article.title}>
  <!-- Premium Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Tailwind is provided by @astrojs/tailwind integration - no CDN needed -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://unpkg.com/@mux/mux-player"></script>
  <style>
    /* Fallback for Tailwind hidden class */
    .hidden { display: none !important; }

    /* Premium Typography */
    body {
      font-family: 'Inter', system-ui, sans-serif;
    }
    h1, h2, h3, .editorial-headline {
      font-family: 'Playfair Display', Georgia, serif;
    }
    .thumbnail-overlay {
      position: relative;
      overflow: hidden;
    }
    .thumbnail-overlay video,
    .thumbnail-overlay img {
      transition: transform 0.3s ease;
    }
    .thumbnail-overlay:hover video,
    .thumbnail-overlay:hover img {
      transform: scale(1.02);
    }
    .thumbnail-gradient {
      background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.3) 40%, transparent 100%);
    }
    .brand-badge {
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }
    .chapter-marker {
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .chapter-marker:hover {
      transform: scale(1.05);
    }
    .prose h2 {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 2rem;
      font-weight: 600;
      color: #111827;
      margin-top: 3rem;
      margin-bottom: 1.5rem;
      letter-spacing: -0.02em;
      position: relative;
    }
    .prose h2::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 0;
      width: 60px;
      height: 3px;
      background: linear-gradient(90deg, #f59e0b, #fbbf24);
      border-radius: 2px;
    }
    .prose p {
      color: #374151;
      line-height: 1.9;
      margin-bottom: 1.75rem;
      font-size: 1.125rem;
      letter-spacing: 0.01em;
    }
    .prose p:first-of-type {
      font-size: 1.25rem;
      color: #1f2937;
      font-weight: 400;
    }
    .prose p + p {
      margin-top: 1.5rem;
    }
    .prose strong, .prose b {
      color: #1f2937;
      font-weight: 600;
      background: linear-gradient(120deg, #fef3c7 0%, #fde68a 100%);
      padding: 0.1rem 0.4rem;
      border-radius: 0.25rem;
      box-decoration-break: clone;
    }
    .prose a {
      color: #b45309;
      text-decoration: none;
      border-bottom: 2px solid #fde68a;
      font-weight: 500;
      transition: all 0.2s;
    }
    .prose a:hover {
      color: #92400e;
      border-bottom-color: #f59e0b;
      background: #fef3c7;
    }
    .prose ul, .prose ol {
      margin-bottom: 1.75rem;
      padding-left: 1.5rem;
    }
    .prose li {
      margin-bottom: 0.75rem;
      color: #374151;
      line-height: 1.7;
    }
    .prose li strong {
      display: inline;
    }
    .pull-quote {
      position: relative;
      border-left: 4px solid #f59e0b;
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 50%, #fff 100%);
      padding: 2rem 2.5rem;
      margin: 2.5rem 0;
      font-size: 1.35rem;
      font-style: italic;
      color: #1f2937;
      border-radius: 0 1rem 1rem 0;
      box-shadow: 0 4px 20px rgba(245, 158, 11, 0.15);
    }
    .pull-quote::before {
      content: '"';
      position: absolute;
      top: -0.5rem;
      left: 1rem;
      font-size: 4rem;
      color: #f59e0b;
      opacity: 0.3;
      font-family: Georgia, serif;
      line-height: 1;
    }
    .callout-card {
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
      border: 2px solid #f59e0b;
      border-radius: 1rem;
      padding: 1.5rem 2rem;
      margin: 2rem 0;
      box-shadow: 0 8px 25px rgba(245, 158, 11, 0.2);
    }
    .callout-card h4 {
      font-size: 1.25rem;
      font-weight: 700;
      color: #92400e;
      margin-bottom: 0.75rem;
    }
    .callout-card p {
      color: #78350f;
      font-size: 1.05rem;
      line-height: 1.6;
    }
    .translucent-section {
      position: relative;
      overflow: hidden;
    }
    .translucent-section::before {
      content: '';
      position: absolute;
      inset: 0;
      background-size: cover;
      background-position: center;
      opacity: 0.08;
      filter: blur(2px);
    }
    .country-card {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border: 1px solid #e2e8f0;
      transition: all 0.2s ease;
    }
    .country-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    .country-card.featured {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-color: #f59e0b;
    }
    /* Episodic color bar under hero */
    .episodic-bar {
      display: flex;
      height: 4px;
      background: #1f2937;
    }
    .episodic-bar span {
      flex: 1;
      transition: opacity 0.3s;
    }
    .episodic-bar span:hover {
      opacity: 0.7;
    }
    /* Hook/provocative opener */
    .hook-statement {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1f2937;
      border-left: 4px solid #f59e0b;
      padding-left: 1.5rem;
      margin: 2rem 0;
      line-height: 1.4;
    }
    .hook-statement .highlight {
      background: linear-gradient(120deg, #fef3c7 0%, #fde68a 100%);
      padding: 0.125rem 0.5rem;
      border-radius: 0.25rem;
    }
    /* Styled bullet lists as cards */
    .prose ul {
      list-style: none;
      padding-left: 0;
      display: grid;
      gap: 0.75rem;
      margin: 1.5rem 0;
    }
    .prose ul li {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border: 1px solid #e2e8f0;
      border-left: 3px solid #f59e0b;
      padding: 1rem 1.25rem;
      border-radius: 0 0.5rem 0.5rem 0;
      margin-bottom: 0;
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
    }
    .prose ul li::before {
      content: '‚Üí';
      color: #f59e0b;
      font-weight: bold;
      flex-shrink: 0;
    }
    /* Weather/temperature card */
    .weather-card {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      border: 1px solid #93c5fd;
      padding: 0.5rem 1rem;
      border-radius: 2rem;
      font-size: 0.9rem;
      font-weight: 500;
      color: #1e40af;
    }
    .weather-card .temp {
      font-size: 1.1rem;
      font-weight: 700;
    }
    /* More aggressive paragraph spacing */
    .prose p {
      margin-bottom: 1.75rem !important;
    }
    .prose p br {
      display: block;
      content: '';
      margin-top: 1rem;
    }
    /* Sentence-level spacing for mobile */
    @media (max-width: 768px) {
      .prose p {
        font-size: 1rem;
        line-height: 2;
        margin-bottom: 2rem !important;
      }
      .prose ul li {
        padding: 0.875rem 1rem;
      }
      .hook-statement {
        font-size: 1.25rem;
      }
    }
    /* Animations */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px rgba(245, 158, 11, 0.3); }
      50% { box-shadow: 0 0 40px rgba(245, 158, 11, 0.6); }
    }
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }
    .animate-fade-in {
      animation: fadeInUp 0.6s ease-out forwards;
    }
    .animate-pulse-glow {
      animation: pulse-glow 2s ease-in-out infinite;
    }
    .animate-float {
      animation: float 3s ease-in-out infinite;
    }
    .animate-shimmer {
      background: linear-gradient(90deg, #f59e0b 0%, #fbbf24 50%, #f59e0b 100%);
      background-size: 200% 100%;
      animation: shimmer 2s linear infinite;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    /* Scroll-triggered animations */
    .reveal {
      opacity: 0;
      transform: translateY(30px);
      transition: all 0.8s ease;
    }
    .reveal.visible {
      opacity: 1;
      transform: translateY(0);
    }
    /* Visual break cards */
    .visual-break {
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
      border-radius: 1rem;
      padding: 2rem;
      margin: 2rem -1rem;
    }
    .visual-break-amber {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 50%, #fef3c7 100%);
      background-size: 200% 100%;
      animation: shimmer 3s linear infinite;
    }
    /* Stat counter style */
    .stat-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 2rem;
      font-weight: 700;
      font-size: 0.9rem;
      box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
    }
    /* Enhanced blockquote styling */
    .prose blockquote {
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
      border-left: 4px solid #f59e0b;
      border-radius: 0 1rem 1rem 0;
      padding: 1.5rem 2rem;
      margin: 2rem 0;
      position: relative;
      overflow: hidden;
    }
    .prose blockquote::before {
      content: '"';
      position: absolute;
      top: -10px;
      left: 15px;
      font-size: 6rem;
      color: #f59e0b;
      opacity: 0.15;
      font-family: Georgia, serif;
      line-height: 1;
    }
    .prose blockquote p {
      color: #e5e7eb !important;
      font-style: italic;
      font-size: 1.1rem;
      line-height: 1.7;
      margin-bottom: 0 !important;
    }
    /* Testimonial card styling */
    .testimonial-card {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 1rem;
      padding: 1.5rem;
      margin: 2rem 0;
      position: relative;
      box-shadow: 0 10px 40px rgba(245, 158, 11, 0.2);
      border: 2px solid #f59e0b;
    }
    .testimonial-card::before {
      content: 'üí¨';
      position: absolute;
      top: -15px;
      left: 20px;
      font-size: 1.5rem;
      background: white;
      padding: 0.25rem 0.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .testimonial-card .quote {
      font-size: 1.1rem;
      font-style: italic;
      color: #78350f;
      line-height: 1.6;
      margin-bottom: 1rem;
    }
    .testimonial-card .attribution {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .testimonial-card .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      color: white;
      font-weight: bold;
    }
    .testimonial-card .name {
      font-weight: 700;
      color: #92400e;
    }
    .testimonial-card .role {
      font-size: 0.85rem;
      color: #a16207;
    }
    /* Animated gradient text */
    @keyframes gradient-shift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .gradient-text {
      background: linear-gradient(90deg, #f59e0b, #ef4444, #8b5cf6, #f59e0b);
      background-size: 300% 100%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: gradient-shift 4s ease infinite;
    }
  </style>
</head>
<body class="bg-white">
  <!-- Hero Section with Video - Clean video, title below -->
  <!-- Non-story modes start at 0.5s to show different frame than story video -->
  {playbackId ? (
    <header class="bg-gray-900">
      <div class="max-w-6xl mx-auto">
        <mux-player
          playback-id={playbackId}
          accent-color="#f59e0b"
          autoplay="muted"
          loop
          start-time={isClusterMode && currentMode !== 'story' ? '0.5' : '0'}
          class="w-full aspect-video"
        />
      </div>
    </header>
  ) : (
    <header class="bg-gray-100 py-16">
      <div class="max-w-4xl mx-auto px-4">
        {article.article_angle && (
          <span class="text-amber-600 text-sm font-semibold uppercase tracking-wider">{article.article_angle}</span>
        )}
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mt-2 mb-4">{article.title}</h1>
        {excerpt && (
          <p class="text-xl text-gray-600">{excerpt}</p>
        )}
      </div>
    </header>
  )}

  <!-- Episodic Color Bar -->
  {playbackId && fourActContent.length >= 4 && (
    <div class="episodic-bar">
      <span class="bg-blue-500" onclick="seekTo(0)"></span>
      <span class="bg-purple-500" onclick="seekTo(3)"></span>
      <span class="bg-amber-500" onclick="seekTo(6)"></span>
      <span class="bg-emerald-500" onclick="seekTo(9)"></span>
    </div>
  )}

  <!-- Title Section - Editorial magazine style -->
  {playbackId && (
    <div class="bg-gradient-to-b from-gray-900 via-gray-900 to-gray-800 pt-8 pb-6">
      <div class="max-w-4xl mx-auto px-4 animate-fade-in">
        {article.article_angle && (
          <div class="flex items-center gap-3 mb-4">
            <span class="bg-amber-500 text-black text-[10px] font-bold uppercase tracking-widest px-3 py-1 rounded-full">{article.article_angle}</span>
            <span class="text-gray-500 text-xs">‚Ä¢</span>
            <span class="text-gray-400 text-xs font-medium">{article.word_count?.toLocaleString() || '2,500'} words</span>
            <span class="text-gray-500 text-xs">‚Ä¢</span>
            <span class="text-gray-400 text-xs font-medium">12 min read</span>
          </div>
        )}
        <h1 class="editorial-headline text-3xl md:text-5xl font-semibold text-white mt-2 mb-4 leading-tight">{article.title}</h1>
        {excerpt && (
          <p class="text-base md:text-lg text-gray-300 font-light leading-relaxed max-w-3xl">{excerpt}</p>
        )}
        <div class="flex items-center gap-4 mt-6 pt-6 border-t border-gray-700/50">
          <div class="w-10 h-10 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center text-white font-bold text-sm">RQ</div>
          <div>
            <p class="text-white text-sm font-medium">Relocation Quest Editorial</p>
            <p class="text-gray-400 text-xs">{new Date(article.published_at || article.created_at).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</p>
          </div>
        </div>
      </div>
    </div>
  )}

  <!-- Chapter Timeline - Stacked on mobile -->
  {playbackId && fourActContent.length >= 4 && (
    <div class="bg-gray-900 pb-4">
      <div class="max-w-4xl mx-auto px-4">
        <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Chapters</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
          {fourActContent.slice(0, 4).map((section, i) => {
            const colors = ['blue', 'purple', 'amber', 'emerald'];
            const color = colors[i] || 'gray';
            const chapterLabel = section.video_title || section.title?.split(':')[0]?.substring(0, 20) || `Part ${i + 1}`;
            return (
              <button onclick={`seekTo(${i * 3})`} class="chapter-marker group text-left">
                <div class={`h-1 bg-${color}-500/60 rounded-full group-hover:bg-${color}-400 mb-1`}></div>
                <span class="text-xs text-gray-400 block truncate">{chapterLabel}</span>
              </button>
            );
          })}
        </div>
      </div>
    </div>
  )}

  <script>
    function seekTo(time) {
      const player = document.querySelector('mux-player');
      if (player) player.currentTime = time;
    }
  </script>

  <!-- Content Mode Toggle (Story/Guide/YOLO) for Country Guides -->
  <!-- Cluster mode: Use actual links (SEO-friendly separate pages) -->
  <!-- Legacy mode: Use JS toggle (single page with hidden content) -->
  {hasContentModes && (
    <div class="bg-gray-50 border-b border-gray-200 sticky top-0 z-40">
      <div class="max-w-4xl mx-auto px-4 py-3">
        <div class="flex items-center justify-between">
          <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Reading Mode</span>

          {/* Cluster mode: Navigation links to separate articles */}
          {isClusterMode ? (
            <div class="flex gap-1 bg-gray-200 rounded-lg p-1">
              {clusterArticles.map((ca: any) => {
                const mode = ca.article_mode || 'story';
                const config = modeConfig[mode] || modeConfig.story;
                const isActive = ca.slug === slug;
                return (
                  <a
                    href={`/${ca.slug}`}
                    class={`px-4 py-2 text-sm font-medium rounded-md transition-all ${
                      isActive
                        ? 'bg-white text-gray-900 shadow-sm'
                        : 'text-gray-600 hover:text-gray-900 hover:bg-gray-100'
                    }`}
                  >
                    <span class="mr-1">{config.icon}</span>
                    {config.label}
                  </a>
                );
              })}
            </div>
          ) : (
            /* Legacy mode: JS toggle buttons */
            <div class="flex gap-1 bg-gray-200 rounded-lg p-1" id="content-mode-toggle">
              <button
                data-mode="story"
                class="mode-btn px-4 py-2 text-sm font-medium rounded-md transition-all bg-white text-gray-900 shadow-sm"
                onclick="switchMode('story')"
              >
                üìñ Story
              </button>
              {contentModes.guide && (
                <button
                  data-mode="guide"
                  class="mode-btn px-4 py-2 text-sm font-medium rounded-md transition-all text-gray-600 hover:text-gray-900"
                  onclick="switchMode('guide')"
                >
                  üìã Guide
                </button>
              )}
              {contentModes.yolo && (
                <button
                  data-mode="yolo"
                  class="mode-btn px-4 py-2 text-sm font-medium rounded-md transition-all text-gray-600 hover:text-gray-900"
                  onclick="switchMode('yolo')"
                >
                  üöÄ YOLO
                </button>
              )}
              {voices.length > 0 && (
                <button
                  data-mode="voices"
                  class="mode-btn px-4 py-2 text-sm font-medium rounded-md transition-all text-gray-600 hover:text-gray-900"
                  onclick="switchMode('voices')"
                >
                  üéôÔ∏è Voices ({voices.length})
                </button>
              )}
            </div>
          )}
        </div>
        <p class="text-xs text-gray-400 mt-1" id="mode-description">
          {isClusterMode
            ? `${modeConfig[currentMode]?.label || 'Story'} mode - ${currentMode === 'story' ? 'Narrative journey' : currentMode === 'guide' ? 'Practical steps' : currentMode === 'yolo' ? 'Adventure edition' : 'Real experiences'}`
            : 'Narrative journey through relocation'
          }
        </p>
      </div>
    </div>
  )}

  <main class="max-w-4xl mx-auto px-4 py-12">
    <!-- Default 4-Act Content (hidden when content modes exist) -->
    <div id="default-content" style={hasContentModes ? "display: none" : ""}>
    <!-- Preamble (content before first H2) -->
    {contentSections[0] && !contentSections[0].startsWith('<h2') && (
      <div class="prose prose-lg max-w-none mb-8">
        <div set:html={contentSections[0]} />
      </div>
    )}

    <!-- Hook Statement - Provocative opener -->
    {fourActContent[0]?.factoid && (
      <div class="hook-statement">
        <span class="highlight">{fourActContent[0].factoid}</span>
      </div>
    )}

    <!-- 4-Act Ticker Tape - HLS Video Chapter Navigation -->
    {playbackId && fourActContent.length >= 4 && (
      <div class="bg-gray-900 -mx-4 md:-mx-8 lg:-mx-16 px-4 md:px-8 lg:px-16 py-8 my-12 rounded-none md:rounded-2xl">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 max-w-5xl mx-auto">
          {fourActContent.slice(0, 4).map((section, i) => {
            const actTime = actTimestamps[i];
            const actTitles = ['The Grind', 'The Dream', 'The Journey', 'The Reality'];
            const actTitle = section.video_title || actTitles[i];
            return (
              <button onclick={`seekTo(${actTime.start})`} class="bg-gray-800 rounded-lg overflow-hidden text-left hover:bg-gray-700 transition group">
                <video
                  class="ticker-video w-full aspect-video object-cover"
                  muted
                  playsinline
                  loop
                  poster={getMuxThumbnail(actTime.mid, 480)}
                  data-hls={getMuxStream()}
                  data-start={actTime.start}
                  data-end={actTime.end}
                ></video>
                <div class="p-3">
                  <h3 class="font-semibold text-white text-sm">{actTitle}</h3>
                  <p class="text-xs text-gray-400 mt-1 line-clamp-2">{section.factoid || `${actTime.start}-${actTime.end}s`}</p>
                </div>
              </button>
            );
          })}
        </div>
      </div>
    )}

    <!-- Video Progress Divider - Aesthetic text breaker -->
    {playbackId && (
      <div class="my-12 flex items-center justify-center gap-3 text-xs text-gray-400 font-mono">
        <span class="w-8 h-px bg-gradient-to-r from-transparent to-gray-300"></span>
        <span class="text-blue-500">0s</span>
        <span class="w-12 h-px bg-blue-300/50"></span>
        <span class="text-purple-500">3s</span>
        <span class="w-12 h-px bg-purple-300/50"></span>
        <span class="text-amber-500">6s</span>
        <span class="w-12 h-px bg-amber-300/50"></span>
        <span class="text-emerald-500">9s</span>
        <span class="w-12 h-px bg-emerald-300/50"></span>
        <span class="text-emerald-600">12s</span>
        <span class="w-8 h-px bg-gradient-to-l from-transparent to-gray-300"></span>
      </div>
    )}

    <!-- 4-Act Sections -->
    {fourActContent.slice(0, 4).map((section, i) => {
      const actTime = actTimestamps[i];
      const sectionContent = contentSections.find(c => c.includes(section.title)) || '';
      const calloutForSection = callouts.find(c => c.placement === `after_section_${i + 1}`);
      const showTimeline = i === 1 && timeline.length > 0;  // After section 2
      const showStoryline = i === 2 && playbackId;  // 2x2 video grid after section 3 (deeper in content)
      const useTranslucentBg = i === 3;

      return (
        <section class={`mb-16 ${useTranslucentBg ? 'relative bg-gradient-to-br from-amber-50/80 to-orange-50/60 -mx-4 md:-mx-8 px-4 md:px-8 py-8 rounded-2xl' : ''}`}>
          {/* Translucent video background for final section */}
          {useTranslucentBg && playbackId && (
            <div class="absolute inset-0 rounded-2xl overflow-hidden -z-10">
              <img src={getMuxThumbnail(10, 1600)} alt="" class="w-full h-full object-cover opacity-[0.15] blur-[1px]" />
              <div class="absolute inset-0 bg-gradient-to-br from-amber-50/40 via-white/50 to-orange-50/40"></div>
            </div>
          )}

          <!-- Section Header with HLS Video (bounded loop) -->
          {playbackId && (
            <div class="thumbnail-overlay rounded-xl mb-6">
              <video
                class="section-video w-full aspect-[21/9] object-cover rounded-xl"
                muted
                playsinline
                loop
                poster={getMuxThumbnail(actTime.mid, 800)}
                data-hls={getMuxStream()}
                data-start={actTime.start}
                data-end={actTime.end}
              ></video>
              <div class="absolute inset-0 thumbnail-gradient rounded-xl pointer-events-none"></div>
              <div class="absolute top-3 right-3">
                <span class="brand-badge text-white/80">Relocation Quest</span>
              </div>
              <div class="absolute bottom-4 left-4 right-4">
                <h2 class="text-xl md:text-2xl font-bold text-white drop-shadow-lg">{section.title}</h2>
                {section.factoid && (
                  <p class="text-white/80 text-sm mt-1 drop-shadow">{section.factoid}</p>
                )}
              </div>
            </div>
          )}

          <!-- Section Content -->
          {sectionContent ? (
            <div class="prose prose-lg max-w-none" set:html={sectionContent} />
          ) : (
            <div class="prose prose-lg max-w-none">
              <h2>{section.title}</h2>
            </div>
          )}

          <!-- Pull Quote (mid-section text breaker) -->
          {i === 0 && section.factoid && (
            <div class="pull-quote reveal">
              "{section.factoid}"
            </div>
          )}

          <!-- Visual Stat Break after section 1 - Mobile content breaker -->
          {i === 0 && playbackId && (
            <div class="visual-break my-8 reveal">
              <div class="flex items-center justify-center gap-6 text-white">
                <div class="text-center">
                  <div class="text-3xl font-bold text-amber-400 animate-float">üå¥</div>
                  <div class="text-xs text-gray-400 mt-1">300+ Days Sun</div>
                </div>
                <div class="w-px h-12 bg-gray-700"></div>
                <div class="text-center">
                  <div class="text-3xl font-bold text-amber-400 animate-float" style="animation-delay: 0.5s">üíº</div>
                  <div class="text-xs text-gray-400 mt-1">Remote Work Ready</div>
                </div>
                <div class="w-px h-12 bg-gray-700"></div>
                <div class="text-center">
                  <div class="text-3xl font-bold text-amber-400 animate-float" style="animation-delay: 1s">üá™üá∫</div>
                  <div class="text-xs text-gray-400 mt-1">EU Access</div>
                </div>
              </div>
            </div>
          )}

          <!-- Callout after section (if any) -->
          {calloutForSection && (
            <div class="my-8 bg-amber-50 border-l-4 border-amber-400 rounded-r-xl overflow-hidden">
              <div class="flex flex-col md:flex-row">
                {playbackId && (
                  <div class="md:w-1/3">
                    <img src={getMuxThumbnail(actTime.mid - 1, 600)} alt="" class="w-full h-48 md:h-full object-cover" />
                  </div>
                )}
                <div class={`p-6 ${playbackId ? 'md:w-2/3' : 'w-full'}`}>
                  <h3 class="text-lg font-bold text-amber-800 mb-2">
                    {calloutForSection.type === 'pro_tip' ? 'üí° ' : calloutForSection.type === 'warning' ? '‚ö†Ô∏è ' : ''}
                    {calloutForSection.title}
                  </h3>
                  <p class="text-amber-900">{calloutForSection.content}</p>
                </div>
              </div>
            </div>
          )}


          <!-- Timeline (text breaker in section 3) -->
          {showTimeline && (
            <div class="my-12">
              <h3 class="text-lg font-bold text-gray-900 mb-6">Key Milestones</h3>
              <div class="relative">
                <div class="absolute left-4 top-0 bottom-0 w-0.5 bg-gradient-to-b from-amber-400 via-amber-300 to-amber-200"></div>
                <div class="space-y-6">
                  {timeline.slice(0, 4).map((event, ti) => (
                    <div class="flex items-start gap-4 pl-4">
                      <div class="w-3 h-3 bg-amber-500 rounded-full mt-1.5 -ml-[7px] ring-4 ring-white"></div>
                      <div class="flex-1 bg-gray-50 rounded-lg p-4">
                        <span class="text-amber-600 text-xs font-semibold">{event.date}</span>
                        <h4 class="font-bold text-gray-900">{event.title}</h4>
                        <p class="text-sm text-gray-600">{event.description}</p>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}

          <!-- 2x2 Storyline HLS Video Grid - Visual content break -->
          {showStoryline && (
            <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 -mx-4 md:-mx-8 lg:-mx-16 px-4 md:px-8 lg:px-16 py-10 my-12 rounded-none md:rounded-2xl reveal">
              <div class="text-center mb-6">
                <span class="stat-pill animate-pulse-glow">üé¨ Your Journey in 12 Seconds</span>
              </div>
              <h3 class="text-lg font-bold text-white mb-6 text-center">The Story So Far</h3>
              <div class="grid grid-cols-2 gap-3 md:gap-4 max-w-3xl mx-auto">
                {fourActContent.slice(0, 4).map((act, ai) => {
                  const actT = actTimestamps[ai];
                  const actTitles = ['The Grind', 'The Dream', 'The Journey', 'The Reality'];
                  const colors = ['from-blue-500', 'from-purple-500', 'from-amber-500', 'from-emerald-500'];
                  return (
                    <div class={`bg-gray-800 rounded-xl overflow-hidden transform hover:scale-105 transition-all duration-300 hover:shadow-xl hover:shadow-${colors[ai].split('-')[1]}-500/20`}>
                      <div class="relative">
                        <video
                          class="storyline-video w-full aspect-video object-cover"
                          muted
                          playsinline
                          loop
                          poster={getMuxThumbnail(actT.mid, 480)}
                          data-hls={getMuxStream()}
                          data-start={actT.start}
                          data-end={actT.end}
                        ></video>
                        <div class={`absolute inset-0 bg-gradient-to-t ${colors[ai]} to-transparent opacity-30`}></div>
                        <div class="absolute top-2 left-2 bg-black/70 px-2 py-1 rounded-full text-xs text-white font-semibold">
                          {ai + 1}. {act.video_title || actTitles[ai]}
                        </div>
                        <div class="absolute bottom-2 right-2 bg-amber-500 text-black px-2 py-0.5 rounded text-[10px] font-bold">
                          {actT.start}-{actT.end}s
                        </div>
                      </div>
                      <div class="p-3 border-t border-gray-700">
                        <p class="text-xs text-gray-300 line-clamp-2 font-medium">{act.factoid}</p>
                      </div>
                    </div>
                  );
                })}
              </div>
              <div class="text-center mt-6">
                <button onclick="document.querySelector('mux-player').scrollIntoView({behavior:'smooth'})" class="text-amber-400 text-sm font-medium hover:text-amber-300 transition">
                  ‚Üë Watch Full Video
                </button>
              </div>
            </div>
          )}

          <!-- Progress divider between sections -->
          {i < 3 && playbackId && (
            <div class="my-10 flex items-center justify-center gap-2 text-[10px] text-gray-300 font-mono">
              {actTimestamps.map((t, ti) => (
                <>
                  <span class={ti <= i ? 'text-amber-400' : 'text-gray-300'}>{t.start}s</span>
                  {ti < 3 && <span class={`w-8 h-px ${ti <= i ? 'bg-amber-300' : 'bg-gray-200'}`}></span>}
                </>
              ))}
              <span class={i >= 3 ? 'text-amber-400' : 'text-gray-300'}>12s</span>
            </div>
          )}
        </section>
      );
    })}

    <!-- Country Comparison Cards (instead of plain table) -->
    {comparison && comparison.items && comparison.items.length > 0 && (
      <section class="mb-16">
        {playbackId && (
          <div class="thumbnail-overlay rounded-xl mb-6">
            <img src={getMuxThumbnail(6, 800)} alt="" class="w-full aspect-[21/9] object-cover rounded-xl" />
            <div class="absolute inset-0 thumbnail-gradient rounded-xl"></div>
            <div class="absolute bottom-4 left-6">
              <h2 class="text-2xl md:text-3xl font-bold text-white drop-shadow-lg">{comparison.title || 'Compare Your Options'}</h2>
            </div>
          </div>
        )}

        <div class="grid md:grid-cols-2 gap-4">
          {comparison.items.map((item, i) => {
            const flag = getCountryFlag(item.name);
            const isFeatured = i === 0;
            return (
              <div class={`country-card rounded-xl p-5 ${isFeatured ? 'featured md:col-span-2' : ''}`}>
                <div class="flex items-start gap-4">
                  <span class="text-4xl">{flag}</span>
                  <div class="flex-1">
                    <h3 class={`font-bold ${isFeatured ? 'text-xl text-amber-900' : 'text-lg text-gray-900'}`}>{item.name}</h3>
                    <div class="mt-3 grid grid-cols-2 gap-3 text-sm">
                      {Object.entries(item).filter(([k]) => k !== 'name').map(([key, value]) => (
                        <div>
                          <span class="text-gray-500 text-xs uppercase tracking-wider">{key.replace(/_/g, ' ')}</span>
                          <p class={`font-medium ${isFeatured ? 'text-amber-800' : 'text-gray-900'}`}>{value}</p>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      </section>
    )}

    <!-- Stat Highlight (if present) -->
    {statHighlight && (
      <section class="mb-16 -mx-4 md:-mx-8 lg:-mx-16">
        <div class="relative py-16 px-8 overflow-hidden">
          {playbackId && (
            <div class="absolute inset-0">
              <img src={getMuxThumbnail(10, 1600)} alt="" class="w-full h-full object-cover opacity-[0.12]" />
              <div class="absolute inset-0 bg-gradient-to-r from-amber-50 via-white/90 to-amber-50"></div>
            </div>
          )}
          <div class="relative max-w-3xl mx-auto text-center">
            <span class="text-amber-600 text-sm font-semibold uppercase tracking-wider">Key Takeaway</span>
            <p class="text-3xl md:text-4xl font-bold text-gray-900 mt-4 mb-6" set:html={statHighlight.headline} />
            {statHighlight.stats && (
              <div class="flex justify-center gap-8 mt-8">
                {statHighlight.stats.map(stat => (
                  <div class="text-center">
                    <div class="text-4xl font-bold text-amber-600">{stat.value}</div>
                    <div class="text-sm text-gray-500 mt-1">{stat.label}</div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      </section>
    )}

    <!-- FAQ Section (if present) -->
    {faq && faq.length > 0 && (
      <section class="mb-16">
        <h2 class="text-3xl font-bold text-gray-900 mb-8">Frequently Asked Questions</h2>
        <div class="grid md:grid-cols-2 gap-6">
          {faq.map((item, i) => {
            const thumbTime = actTimestamps[i % 4]?.mid || 1.5;
            return (
              <div class="bg-gray-50 rounded-xl overflow-hidden">
                {playbackId && (
                  <img src={getMuxThumbnail(thumbTime, 400)} alt="" class="w-full h-32 object-cover opacity-60" />
                )}
                <div class={`p-6 ${playbackId ? '-mt-8' : ''} relative`}>
                  <div class="bg-white rounded-lg shadow-lg p-4">
                    <h3 class="font-bold text-gray-900 mb-2">{item.q}</h3>
                    <p class="text-gray-600 text-sm">{item.a}</p>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      </section>
    )}

    <!-- Sources Section (if present) -->
    {sources && sources.length > 0 && (
      <section class="relative rounded-xl overflow-hidden mb-12">
        {playbackId && (
          <div class="absolute inset-0">
            <img src={getMuxThumbnail(10.5, 800)} alt="" class="w-full h-full object-cover opacity-10" />
            <div class="absolute inset-0 bg-gradient-to-br from-gray-50 via-white/90 to-gray-50"></div>
          </div>
        )}
        <div class="relative p-8">
          <h3 class="font-semibold text-gray-900 mb-4">Sources & References</h3>
          <div class="grid md:grid-cols-3 gap-4">
            {sources.map((source, i) => {
              const thumbTime = actTimestamps[i % 4]?.mid || 1.5;
              return (
                <a href={source.url} target="_blank" rel="noopener" class="flex items-center gap-3 p-3 bg-white/60 rounded-lg hover:bg-white transition">
                  {playbackId && (
                    <img src={getMuxThumbnail(thumbTime, 400)} alt="" class="w-12 h-12 object-cover rounded" />
                  )}
                  <div>
                    <p class="text-sm font-medium text-gray-900">{source.name}</p>
                    {source.description && (
                      <p class="text-xs text-gray-500">{source.description}</p>
                    )}
                  </div>
                </a>
              );
            })}
          </div>
        </div>
      </section>
    )}
    </div><!-- End default-content -->

    <!-- CLUSTER MODE: Display content directly (SEO-friendly, server-rendered) -->
    {isClusterMode && (
      <div id="cluster-content" class="cluster-mode-content">
        <div class="prose prose-lg max-w-none">
          <div set:html={activeContent} />
        </div>

        {/* Voices mode: Display testimonials */}
        {currentMode === 'voices' && voices.length > 0 && (
          <div class="mt-12 space-y-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Real Expat Experiences</h2>
            {voices.map((voice: any, i: number) => (
              <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl p-6 border border-purple-100">
                <div class="flex items-start gap-4">
                  <div class="w-12 h-12 rounded-full bg-purple-200 flex items-center justify-center text-xl">
                    {voice.avatar || 'üë§'}
                  </div>
                  <div class="flex-1">
                    <p class="text-gray-700 text-lg italic mb-4">"{voice.quote || voice.testimonial}"</p>
                    <div class="flex items-center gap-2 text-sm text-gray-600">
                      <span class="font-semibold">{voice.name || `Expat ${i + 1}`}</span>
                      {voice.location && <span>‚Ä¢ {voice.location}</span>}
                      {voice.years && <span>‚Ä¢ {voice.years} years</span>}
                    </div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}

        {/* Cluster navigation at bottom */}
        <div class="mt-16 pt-8 border-t border-gray-200">
          <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Explore Other Perspectives</h3>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            {clusterArticles.filter((ca: any) => ca.slug !== slug).map((ca: any) => {
              const mode = ca.article_mode || 'story';
              const config = modeConfig[mode] || modeConfig.story;
              return (
                <a
                  href={`/${ca.slug}`}
                  class="group block p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition"
                >
                  <span class="text-2xl mb-2 block">{config.icon}</span>
                  <span class="font-medium text-gray-900 group-hover:text-amber-600 transition">{config.label}</span>
                  <p class="text-xs text-gray-500 mt-1">
                    {mode === 'story' ? 'Narrative journey' : mode === 'guide' ? 'Practical steps' : mode === 'yolo' ? 'Adventure edition' : 'Real experiences'}
                  </p>
                </a>
              );
            })}
          </div>
        </div>
      </div>
    )}

    <!-- LEGACY MODE: Story Content (shown by default when content modes exist) -->
    {hasLegacyContentModes && !isClusterMode && contentModes.story && (
      <div id="content-story" class="content-mode" style="display: block;">
        <div style="max-width: 65ch; margin: 0 auto; font-size: 1.125rem; line-height: 1.75;">
          <div set:html={contentModes.story} />
        </div>
      </div>
    )}

    <!-- LEGACY MODE: Guide Content (hidden by default) -->
    {hasLegacyContentModes && !isClusterMode && contentModes.guide && (
      <div id="content-guide" class="content-mode" style="display: none;">
        <div style="max-width: 65ch; margin: 0 auto; font-size: 1.125rem; line-height: 1.75;">
          <div set:html={contentModes.guide} />
        </div>
      </div>
    )}

    <!-- LEGACY MODE: YOLO Content (hidden by default) -->
    {hasLegacyContentModes && !isClusterMode && contentModes.yolo && (
      <div id="content-yolo" class="content-mode" style="display: none;">
        <div style="max-width: 65ch; margin: 0 auto; font-size: 1.125rem; line-height: 1.75;">
          <div set:html={contentModes.yolo} />
        </div>
      </div>
    )}

    <!-- LEGACY MODE: Voices/Testimonials (hidden by default) -->
    {!isClusterMode && voices.length > 0 && (
      <div id="content-voices" class="content-mode" style="display: none;">
        <h2 style="font-size: 1.5rem; font-weight: bold; color: #111827; margin-bottom: 2rem;">Expat Voices</h2>
        <p class="text-gray-600 mb-8">Real stories and insights from people who've made the move.</p>
        <div class="space-y-6">
          {voices.map((voice: any, i: number) => (
            <div class="bg-gradient-to-br from-gray-50 to-white border border-gray-200 rounded-xl p-6 shadow-sm">
              <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center text-white font-bold text-lg flex-shrink-0">
                  {voice.handle?.[0]?.toUpperCase() || voice.author?.[0]?.toUpperCase() || '?'}
                </div>
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 mb-2">
                    <span class="font-semibold text-gray-900">{voice.handle || voice.author || 'Anonymous'}</span>
                    {voice.subreddit && (
                      <span class="text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded">r/{voice.subreddit}</span>
                    )}
                    {voice.platform && (
                      <span class="text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded">{voice.platform}</span>
                    )}
                  </div>
                  <p class="text-gray-700 leading-relaxed">{voice.quote || voice.content}</p>
                  {voice.context && (
                    <p class="text-sm text-gray-500 mt-2 italic">{voice.context}</p>
                  )}
                  {voice.theme && (
                    <span class="inline-block mt-3 text-xs font-medium text-amber-700 bg-amber-50 px-2 py-1 rounded">{voice.theme}</span>
                  )}
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    )}

    <!-- Article Footer -->
    <footer class="pt-8 border-t">
      <div class="flex items-center gap-4">
        {playbackId && (
          <img src={getMuxThumbnail(10.5, 800)} alt="" class="w-16 h-16 object-cover rounded-full border-2 border-amber-200" />
        )}
        <div>
          <p class="text-sm font-medium text-gray-900">Relocation Quest Editorial Team</p>
          <p class="text-xs text-gray-500">
            Published {new Date(article.published_at || article.created_at).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })} ‚Ä¢ {article.word_count} words
          </p>
        </div>
      </div>
      <div class="mt-6">
        <a href="/" class="inline-flex items-center text-amber-600 hover:text-amber-800 font-medium">
          ‚Üê Back to articles
        </a>
      </div>
    </footer>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-900 text-white py-12 mt-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <p class="text-gray-400">¬© {new Date().getFullYear()} Relocation Quest. All rights reserved.</p>
    </div>
  </footer>

  <!-- Currency Conversion Script - USD-led with local currency -->
  <script>
    (async function convertCurrency() {
      // Try to get exchange rates (cache for 1 hour)
      const cacheKey = 'rq_exchange_rates';
      const cacheTime = 'rq_exchange_time';
      let rates = null;

      try {
        const cached = localStorage.getItem(cacheKey);
        const cachedTime = localStorage.getItem(cacheTime);
        const oneHour = 3600000;

        if (cached && cachedTime && (Date.now() - parseInt(cachedTime)) < oneHour) {
          rates = JSON.parse(cached);
        } else {
          const res = await fetch('https://v6.exchangerate-api.com/v6/open/latest/USD');
          const data = await res.json();
          if (data.rates) {
            rates = data.rates;
            localStorage.setItem(cacheKey, JSON.stringify(rates));
            localStorage.setItem(cacheTime, Date.now().toString());
          }
        }
      } catch (e) {
        console.log('Currency conversion unavailable');
        return;
      }

      if (!rates) return;

      // Find all prose sections and convert currencies
      const proseElements = document.querySelectorAll('.prose');

      // Currency patterns to detect (euro-centric content)
      const euroPattern = /‚Ç¨\s*([\d,]+(?:\.\d{2})?)/g;

      proseElements.forEach(prose => {
        const walker = document.createTreeWalker(prose, NodeFilter.SHOW_TEXT, null, false);
        const nodesToUpdate = [];

        while (walker.nextNode()) {
          const node = walker.currentNode;
          if (euroPattern.test(node.textContent)) {
            nodesToUpdate.push(node);
          }
          euroPattern.lastIndex = 0;
        }

        nodesToUpdate.forEach(node => {
          const text = node.textContent;
          const newText = text.replace(euroPattern, (match, amount) => {
            const euroValue = parseFloat(amount.replace(/,/g, ''));
            const eurRate = rates.EUR || 0.92;
            const usdValue = euroValue / eurRate;

            // Format USD as primary
            const usdFormatted = new Intl.NumberFormat('en-US', {
              style: 'currency',
              currency: 'USD',
              minimumFractionDigits: 0,
              maximumFractionDigits: 0
            }).format(usdValue);

            // Keep EUR as local reference
            const eurFormatted = new Intl.NumberFormat('de-DE', {
              style: 'currency',
              currency: 'EUR',
              minimumFractionDigits: 0,
              maximumFractionDigits: 0
            }).format(euroValue);

            return `${usdFormatted} (${eurFormatted})`;
          });

          if (newText !== text) {
            node.textContent = newText;
          }
        });
      });
    })();
  </script>

  <!-- Weather/Temperature Enhancement Script -->
  <script>
    (async function enhanceWeather() {
      // Location coordinates for weather lookup
      const locations = {
        'cyprus': { lat: 35.17, lon: 33.36, name: 'Nicosia' },
        'nicosia': { lat: 35.17, lon: 33.36, name: 'Nicosia' },
        'limassol': { lat: 34.68, lon: 33.04, name: 'Limassol' },
        'portugal': { lat: 38.72, lon: -9.14, name: 'Lisbon' },
        'lisbon': { lat: 38.72, lon: -9.14, name: 'Lisbon' },
        'spain': { lat: 40.42, lon: -3.70, name: 'Madrid' },
        'barcelona': { lat: 41.39, lon: 2.17, name: 'Barcelona' },
        'greece': { lat: 37.98, lon: 23.73, name: 'Athens' },
        'athens': { lat: 37.98, lon: 23.73, name: 'Athens' },
        'malta': { lat: 35.90, lon: 14.51, name: 'Valletta' },
        'croatia': { lat: 45.81, lon: 15.98, name: 'Zagreb' },
        'dubai': { lat: 25.20, lon: 55.27, name: 'Dubai' },
        'bali': { lat: -8.41, lon: 115.19, name: 'Bali' },
        'thailand': { lat: 13.76, lon: 100.50, name: 'Bangkok' },
        'mexico': { lat: 19.43, lon: -99.13, name: 'Mexico City' }
      };

      // Find location mentions in the page title
      const title = document.title.toLowerCase();
      let targetLocation = null;

      for (const [key, coords] of Object.entries(locations)) {
        if (title.includes(key)) {
          targetLocation = { key, ...coords };
          break;
        }
      }

      if (!targetLocation) return;

      try {
        // Use Open-Meteo API (free, no key required)
        const res = await fetch(
          `https://api.open-meteo.com/v1/forecast?latitude=${targetLocation.lat}&longitude=${targetLocation.lon}&current=temperature_2m,weather_code&timezone=auto`
        );
        const data = await res.json();

        if (!data.current) return;

        const temp = Math.round(data.current.temperature_2m);
        const tempF = Math.round((temp * 9/5) + 32);

        // Weather code to emoji mapping
        const weatherEmoji = {
          0: '‚òÄÔ∏è', 1: 'üå§Ô∏è', 2: '‚õÖ', 3: '‚òÅÔ∏è',
          45: 'üå´Ô∏è', 48: 'üå´Ô∏è',
          51: 'üåßÔ∏è', 53: 'üåßÔ∏è', 55: 'üåßÔ∏è',
          61: 'üåßÔ∏è', 63: 'üåßÔ∏è', 65: 'üåßÔ∏è',
          71: 'üå®Ô∏è', 73: 'üå®Ô∏è', 75: 'üå®Ô∏è',
          80: 'üå¶Ô∏è', 81: 'üå¶Ô∏è', 82: 'üå¶Ô∏è',
          95: '‚õàÔ∏è', 96: '‚õàÔ∏è', 99: '‚õàÔ∏è'
        };
        const emoji = weatherEmoji[data.current.weather_code] || 'üå°Ô∏è';

        // Create weather card and insert after hero
        const heroEndMarker = document.querySelector('.episodic-bar') || document.querySelector('header');
        if (heroEndMarker) {
          const weatherCard = document.createElement('div');
          weatherCard.className = 'max-w-4xl mx-auto px-4 py-3';
          weatherCard.innerHTML = `
            <div class="weather-card">
              <span>${emoji}</span>
              <span>${targetLocation.name} right now:</span>
              <span class="temp">${tempF}¬∞F / ${temp}¬∞C</span>
            </div>
          `;
          heroEndMarker.parentNode.insertBefore(weatherCard, heroEndMarker.nextSibling);
        }
      } catch (e) {
        console.log('Weather data unavailable');
      }
    })();
  </script>

  <!-- Sentence Spacing Enhancement Script -->
  <script>
    // Break up long paragraphs into better-spaced sentences
    document.querySelectorAll('.prose p').forEach(p => {
      const text = p.innerHTML;
      // Add spacing after sentences (. followed by capital letter)
      const spaced = text.replace(/(\.)(\s+)([A-Z])/g, '$1<br><br>$3');
      if (spaced !== text) {
        p.innerHTML = spaced;
      }
    });
  </script>

  <!-- Auto-Bold Key Facts Script -->
  <script>
    // Bold key facts: amounts, percentages, time periods, approval rates
    document.querySelectorAll('.prose p, .prose li').forEach(el => {
      let html = el.innerHTML;

      // Skip if already has <strong> or <a> tags in this segment
      const patterns = [
        // Currency amounts (‚Ç¨3,500, $500, ¬£1,000)
        /(?<![<>])([‚Ç¨$¬£]\d{1,3}(?:,\d{3})*(?:\.\d{2})?(?:\s*(?:per|\/)\s*(?:month|year|annually|weekly))?)/g,
        // Percentages with context (92% approval, 5% tax)
        /(?<![<>])(\d{1,3}%\s*(?:approval|tax|rate|interest|discount|increase|decrease)?)/gi,
        // Time periods (3 years, 6-8 weeks, 12 months)
        /(?<![<>])(\d{1,2}(?:-\d{1,2})?\s*(?:years?|months?|weeks?|days?)\s*(?:max(?:imum)?|min(?:imum)?|total|renewable|validity)?)/gi,
        // Key numbers with units (1,000 permits, 518 permits)
        /(?<![<>])(\d{1,3}(?:,\d{3})+\s*(?:permits?|visas?|applications?|people|euros?|dollars?))/gi,
        // Specific stats pattern (e.g., "over 300 days")
        /(?<![<>])(over\s*\d+\s*(?:days?|hours?|years?|months?))/gi,
      ];

      patterns.forEach(pattern => {
        html = html.replace(pattern, (match) => {
          // Don't double-wrap if already in a tag
          if (match.includes('<') || match.includes('>')) return match;
          return `<strong>${match}</strong>`;
        });
      });

      if (html !== el.innerHTML) {
        el.innerHTML = html;
      }
    });
  </script>

  <!-- HLS Video Init Script - Chapter-bounded video loops -->
  <script is:inline>
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof Hls === 'undefined' || !Hls.isSupported()) {
        console.log('HLS not supported, falling back to poster images');
        return;
      }

      const videos = document.querySelectorAll('[data-hls]');
      const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      videos.forEach(function(video) {
        const hlsUrl = video.dataset.hls;
        const start = parseFloat(video.dataset.start) || 0;
        const end = parseFloat(video.dataset.end) || 3;

        if (!hlsUrl) return;

        const hls = new Hls();
        hls.loadSource(hlsUrl);
        hls.attachMedia(video);

        hls.on(Hls.Events.MANIFEST_PARSED, function() {
          video.currentTime = start;
        });

        // Loop within chapter bounds
        video.addEventListener('timeupdate', function() {
          if (video.currentTime >= end) {
            video.currentTime = start;
          }
        });

        // IntersectionObserver for play/pause on visibility
        if (!prefersReducedMotion) {
          const observer = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
              if (entry.isIntersecting && entry.intersectionRatio >= 0.3) {
                video.play().catch(function() {});
              } else {
                video.pause();
              }
            });
          }, { threshold: 0.3 });
          observer.observe(video);
        }
      });
    });
  </script>

  <!-- Scroll Reveal Animation Script -->
  <script is:inline>
    document.addEventListener('DOMContentLoaded', function() {
      const revealElements = document.querySelectorAll('.reveal');

      const revealObserver = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
          if (entry.isIntersecting) {
            entry.target.classList.add('visible');
          }
        });
      }, { threshold: 0.1, rootMargin: '0px 0px -50px 0px' });

      revealElements.forEach(function(el) {
        revealObserver.observe(el);
      });
    });
  </script>

  <!-- Testimonial Auto-Enhancement Script -->
  <script is:inline>
    document.addEventListener('DOMContentLoaded', function() {
      // Find paragraphs with testimonial patterns
      const proseParagraphs = document.querySelectorAll('.prose p');

      proseParagraphs.forEach(function(p) {
        const text = p.textContent;

        // Pattern: Name, role who did something: "quote" or Name, role explains: "quote"
        const testimonialPatterns = [
          /^([A-Z][a-z]+ [A-Z][a-z]+),\s*([^,]+(?:who|from)[^:]+)[:,]\s*["""](.+)["""]/,
          /^([A-Z][a-z]+ [A-Z][a-z]+),\s*([^,]+),\s*([^:]+):\s*["""](.+)["""]/
        ];

        for (let pattern of testimonialPatterns) {
          const match = text.match(pattern);
          if (match) {
            const name = match[1];
            const role = match[2];
            const quote = match[3] || match[4];
            const initials = name.split(' ').map(n => n[0]).join('');

            const card = document.createElement('div');
            card.className = 'testimonial-card reveal visible';
            card.innerHTML = `
              <div class="quote">"${quote}"</div>
              <div class="attribution">
                <div class="avatar">${initials}</div>
                <div>
                  <div class="name">${name}</div>
                  <div class="role">${role}</div>
                </div>
              </div>
            `;
            p.parentNode.replaceChild(card, p);
            break;
          }
        }
      });

      // Also enhance any paragraphs that contain "captures the sentiment:" pattern
      document.querySelectorAll('.prose p').forEach(function(p) {
        const text = p.innerHTML;
        if (text.includes('captures the sentiment:') || text.includes('explains the transformation:') || text.includes('explains:')) {
          // Extract name and quote
          const nameMatch = text.match(/([A-Z][a-z]+ [A-Z][a-z]+),\s*([^,]+),/);
          const quoteMatch = text.match(/["""]([^"""]+)["""]/);

          if (nameMatch && quoteMatch) {
            const name = nameMatch[1];
            const role = nameMatch[2];
            const quote = quoteMatch[1];
            const initials = name.split(' ').map(n => n[0]).join('');

            const card = document.createElement('div');
            card.className = 'testimonial-card reveal visible';
            card.innerHTML = `
              <div class="quote">"${quote}"</div>
              <div class="attribution">
                <div class="avatar">${initials}</div>
                <div>
                  <div class="name">${name}</div>
                  <div class="role">${role}</div>
                </div>
              </div>
            `;
            p.parentNode.replaceChild(card, p);
          }
        }
      });
    });
  </script>

  <!-- Drop Cap Enhancement -->
  <script is:inline>
    document.addEventListener('DOMContentLoaded', function() {
      // Add drop cap to first paragraph of article
      const firstProse = document.querySelector('main .prose p:first-of-type');
      if (firstProse && firstProse.textContent.length > 100) {
        const text = firstProse.innerHTML;
        const firstLetter = text.charAt(0);
        const rest = text.slice(1);
        firstProse.innerHTML = `<span style="float:left;font-family:'Playfair Display',serif;font-size:4.5rem;line-height:0.8;padding-right:0.5rem;color:#f59e0b;font-weight:600;">${firstLetter}</span>${rest}`;
      }
    });
  </script>

  <!-- Content Mode Switching Script -->
  <script is:inline>
    // Mode descriptions
    const modeDescriptions = {
      story: 'Narrative journey through relocation',
      guide: 'Step-by-step practical guide',
      yolo: 'Adventure-focused perspective',
      voices: 'Real experiences from expats'
    };

    // Get story content elements (everything except mode containers)
    function getStoryElements() {
      const main = document.querySelector('main');
      if (!main) return [];
      return Array.from(main.children).filter(el => !el.classList.contains('content-mode') && el.tagName !== 'FOOTER');
    }

    // Switch content mode
    function switchMode(mode) {
      // Update button styles
      document.querySelectorAll('.mode-btn').forEach(btn => {
        const btnMode = btn.getAttribute('data-mode');
        if (btnMode === mode) {
          btn.classList.add('bg-white', 'text-gray-900', 'shadow-sm');
          btn.classList.remove('text-gray-600', 'hover:text-gray-900');
        } else {
          btn.classList.remove('bg-white', 'text-gray-900', 'shadow-sm');
          btn.classList.add('text-gray-600', 'hover:text-gray-900');
        }
      });

      // Update description
      const descEl = document.getElementById('mode-description');
      if (descEl && modeDescriptions[mode]) {
        descEl.textContent = modeDescriptions[mode];
      }

      // Default content is already hidden server-side when content modes exist
      // Just switch between content-mode containers

      // Hide all mode containers first
      const allContainers = document.querySelectorAll('.content-mode');
      console.log('[DEBUG] Found', allContainers.length, 'content-mode containers');
      allContainers.forEach(el => {
        console.log('[DEBUG] Hiding:', el.id);
        el.style.display = 'none';
      });

      // Show the selected mode container (story, guide, yolo, or voices)
      const targetContainer = document.getElementById('content-' + mode);
      console.log('[DEBUG] Looking for container:', 'content-' + mode, '- Found:', !!targetContainer);
      if (targetContainer) {
        targetContainer.style.display = 'block';
        targetContainer.style.visibility = 'visible';
        targetContainer.style.opacity = '1';
        targetContainer.style.height = 'auto';
        console.log('[DEBUG] Showing container:', 'content-' + mode, 'Content length:', targetContainer.innerHTML.length);
      } else {
        console.log('[DEBUG] Container not found:', 'content-' + mode);
        // Fallback: show all content-mode containers
        allContainers.forEach(el => {
          el.style.display = 'block';
        });
      }

      // Save preference
      try {
        localStorage.setItem('rq_content_mode', mode);
      } catch (e) {}

      // Scroll to top of content
      const main = document.querySelector('main');
      if (main) {
        main.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    // Make switchMode globally available
    window.switchMode = switchMode;

    // Initialize content mode on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Debug: Log all content-mode containers
      const allModes = document.querySelectorAll('.content-mode');
      console.log('[DEBUG] Content mode containers found:', allModes.length);
      allModes.forEach((el, i) => {
        console.log(`  [${i}] ${el.id}: ${el.innerHTML.length} chars, display: ${el.style.display}`);
      });

      // Check if content modes exist (content-story container present)
      const hasContentModes = document.getElementById('content-story');
      console.log('[DEBUG] content-story exists:', !!hasContentModes);

      if (hasContentModes) {
        console.log('[DEBUG] content-story innerHTML length:', hasContentModes.innerHTML.length);
        console.log('[DEBUG] content-story first 200 chars:', hasContentModes.innerHTML.substring(0, 200));

        // Server already renders story mode visible - only switch if saved preference differs
        try {
          const savedMode = localStorage.getItem('rq_content_mode');
          if (savedMode && savedMode !== 'story' && document.getElementById('content-' + savedMode)) {
            console.log('[DEBUG] Switching to saved mode:', savedMode);
            switchMode(savedMode);
          } else {
            // Story is already visible from server render - just update button styles
            console.log('[DEBUG] Story mode already visible, just updating UI');
            document.querySelectorAll('.mode-btn').forEach(btn => {
              const isActive = btn.dataset.mode === 'story';
              btn.style.backgroundColor = isActive ? 'white' : 'transparent';
              btn.style.color = isActive ? '#111827' : '#6b7280';
              btn.style.fontWeight = isActive ? '600' : '400';
            });
          }
        } catch (e) {
          console.log('[DEBUG] Error:', e);
        }
      }
    });
  </script>
</body>
</html>
