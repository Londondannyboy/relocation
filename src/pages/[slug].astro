---
import { sql } from '../lib/db';

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/');
}

// Fetch the article with 4-act structured data
const articleResult = await sql`
  SELECT
    a.id,
    a.title,
    a.content,
    a.meta_description as excerpt,
    a.slug,
    a.published_at,
    a.created_at,
    a.article_angle,
    a.word_count,
    a.video_url,
    a.video_playback_id,
    a.featured_asset_url,
    a.hero_asset_url,
    a.video_narrative,
    a.payload
  FROM articles a
  WHERE a.slug = ${slug}
    AND a.app = 'relocation'
  LIMIT 1
`;

const article = articleResult[0];

if (!article) {
  return Astro.redirect('/');
}

// Fetch related articles
const relatedResult = await sql`
  SELECT slug, title, meta_description, video_playback_id, article_angle
  FROM articles
  WHERE app = 'relocation'
    AND slug != ${slug}
    AND published_at IS NOT NULL
  ORDER BY created_at DESC
  LIMIT 3
`;
const relatedArticles = relatedResult || [];

// Parse video_narrative (4-act video data)
let videoData: any = null;
try {
  videoData = typeof article.video_narrative === 'string'
    ? JSON.parse(article.video_narrative)
    : article.video_narrative;
} catch (e) {
  console.error('Failed to parse video_narrative:', e);
}

// Parse payload for structured content (sections, FAQ, callouts, etc.)
let fourActContent: any[] = [];
let faq: any[] = [];
let callouts: any[] = [];
let statHighlight: any = null;
let comparison: any = null;
let timeline: any[] = [];
let sources: any[] = [];

try {
  const payload = typeof article.payload === 'string'
    ? JSON.parse(article.payload)
    : article.payload;
  if (payload) {
    fourActContent = payload.four_act_content || payload.sections || [];
    faq = payload.faq || [];
    callouts = payload.callouts || [];
    statHighlight = payload.stat_highlight || null;
    comparison = payload.comparison || null;
    timeline = payload.timeline || [];
    sources = payload.sources || [];
  }
} catch (e) {
  console.error('Failed to parse payload:', e);
}

// Get playback ID from video_narrative or direct field
const playbackId = videoData?.playback_id || article.video_playback_id;

// Act timestamps for bounded video loops
const actTimestamps = [
  { start: 0, end: 3, mid: 1.5, label: 'Act 1' },
  { start: 3, end: 6, mid: 4.5, label: 'Act 2' },
  { start: 6, end: 9, mid: 7.5, label: 'Act 3' },
  { start: 9, end: 12, mid: 10.5, label: 'Act 4' }
];

// Helper to get Mux thumbnail URL
function getMuxThumbnail(time: number, width: number = 800) {
  if (!playbackId) return '';
  return `https://image.mux.com/${playbackId}/thumbnail.jpg?time=${time}&width=${width}`;
}

// Helper to get Mux stream URL
function getMuxStream() {
  if (!playbackId) return '';
  return `https://stream.mux.com/${playbackId}.m3u8`;
}

// Country flag emoji mapping
const countryFlags: Record<string, string> = {
  'cyprus': 'üá®üáæ', 'portugal': 'üáµüáπ', 'spain': 'üá™üá∏', 'greece': 'üá¨üá∑',
  'italy': 'üáÆüáπ', 'malta': 'üá≤üáπ', 'croatia': 'üá≠üá∑', 'estonia': 'üá™üá™',
  'germany': 'üá©üá™', 'france': 'üá´üá∑', 'netherlands': 'üá≥üá±', 'uk': 'üá¨üáß',
  'uae': 'üá¶üá™', 'dubai': 'üá¶üá™', 'singapore': 'üá∏üá¨', 'usa': 'üá∫üá∏',
  'canada': 'üá®üá¶', 'australia': 'üá¶üá∫', 'thailand': 'üáπüá≠', 'indonesia': 'üáÆüá©',
  'mexico': 'üá≤üáΩ', 'costa rica': 'üá®üá∑', 'brazil': 'üáßüá∑'
};

function getCountryFlag(name: string): string {
  const lower = name.toLowerCase();
  for (const [country, flag] of Object.entries(countryFlags)) {
    if (lower.includes(country)) return flag;
  }
  return 'üåç';
}

// Split content by H2 headers to match with fourActContent sections
function splitContentBySections(html: string): string[] {
  if (!html) return [];
  const sections = html.split(/<h2[^>]*>/i);
  return sections.map((s, i) => {
    if (i === 0) return s;
    return '<h2>' + s;
  }).filter(s => s.trim());
}

const contentSections = splitContentBySections(article.content || '');

// Clean up excerpt
let excerpt = article.excerpt || '';
if (excerpt && !excerpt.endsWith('.') && !excerpt.endsWith('!') && !excerpt.endsWith('?')) {
  const lastSentence = Math.max(excerpt.lastIndexOf('.'), excerpt.lastIndexOf('?'), excerpt.lastIndexOf('!'));
  if (lastSentence > excerpt.length * 0.5) {
    excerpt = excerpt.substring(0, lastSentence + 1);
  } else {
    excerpt = excerpt.trim() + '...';
  }
}
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{article.title} - Relocation Quest</title>
  <meta name="description" content={excerpt || article.title}>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://unpkg.com/@mux/mux-player"></script>
  <style>
    .thumbnail-overlay {
      position: relative;
      overflow: hidden;
    }
    .thumbnail-overlay video,
    .thumbnail-overlay img {
      transition: transform 0.3s ease;
    }
    .thumbnail-overlay:hover video,
    .thumbnail-overlay:hover img {
      transform: scale(1.02);
    }
    .thumbnail-gradient {
      background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.3) 40%, transparent 100%);
    }
    .brand-badge {
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }
    .chapter-marker {
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .chapter-marker:hover {
      transform: scale(1.05);
    }
    .prose h2 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #111827;
      margin-top: 2rem;
      margin-bottom: 1rem;
    }
    .prose p {
      color: #374151;
      line-height: 1.85;
      margin-bottom: 1.5rem;  /* Increased spacing between paragraphs */
    }
    .prose p + p {
      margin-top: 1.5rem;  /* Extra spacing between consecutive paragraphs */
    }
    .prose strong, .prose b {
      color: #1f2937;
      font-weight: 700;
      background: linear-gradient(120deg, #fef3c7 0%, #fde68a 100%);
      padding: 0 0.25rem;
      border-radius: 0.125rem;
    }
    .prose a {
      color: #d97706;
      text-decoration: underline;
      text-underline-offset: 2px;
      font-weight: 500;
      transition: color 0.2s;
    }
    .prose a:hover {
      color: #b45309;
    }
    .prose ul, .prose ol {
      margin-bottom: 1.75rem;
      padding-left: 1.5rem;
    }
    .prose li {
      margin-bottom: 0.75rem;
      color: #374151;
      line-height: 1.7;
    }
    .prose li strong {
      display: inline;
    }
    .pull-quote {
      position: relative;
      border-left: 4px solid #f59e0b;
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 50%, #fff 100%);
      padding: 2rem 2.5rem;
      margin: 2.5rem 0;
      font-size: 1.35rem;
      font-style: italic;
      color: #1f2937;
      border-radius: 0 1rem 1rem 0;
      box-shadow: 0 4px 20px rgba(245, 158, 11, 0.15);
    }
    .pull-quote::before {
      content: '"';
      position: absolute;
      top: -0.5rem;
      left: 1rem;
      font-size: 4rem;
      color: #f59e0b;
      opacity: 0.3;
      font-family: Georgia, serif;
      line-height: 1;
    }
    .callout-card {
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
      border: 2px solid #f59e0b;
      border-radius: 1rem;
      padding: 1.5rem 2rem;
      margin: 2rem 0;
      box-shadow: 0 8px 25px rgba(245, 158, 11, 0.2);
    }
    .callout-card h4 {
      font-size: 1.25rem;
      font-weight: 700;
      color: #92400e;
      margin-bottom: 0.75rem;
    }
    .callout-card p {
      color: #78350f;
      font-size: 1.05rem;
      line-height: 1.6;
    }
    .translucent-section {
      position: relative;
      overflow: hidden;
    }
    .translucent-section::before {
      content: '';
      position: absolute;
      inset: 0;
      background-size: cover;
      background-position: center;
      opacity: 0.08;
      filter: blur(2px);
    }
    .country-card {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border: 1px solid #e2e8f0;
      transition: all 0.2s ease;
    }
    .country-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    .country-card.featured {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-color: #f59e0b;
    }
  </style>
</head>
<body class="bg-white">
  <!-- Hero Section with Video -->
  {playbackId ? (
    <header class="relative bg-gray-900">
      <div class="max-w-6xl mx-auto">
        <mux-player
          playback-id={playbackId}
          accent-color="#f59e0b"
          autoplay="muted"
          loop
          class="w-full aspect-video"
        />
      </div>
      <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-8">
        <div class="max-w-4xl mx-auto">
          {article.article_angle && (
            <span class="text-amber-400 text-sm font-semibold uppercase tracking-wider">{article.article_angle}</span>
          )}
          <h1 class="text-4xl md:text-5xl font-bold text-white mt-2 mb-4">{article.title}</h1>
          {excerpt && (
            <p class="text-xl text-gray-200">{excerpt}</p>
          )}
        </div>
      </div>
    </header>
  ) : (
    <header class="bg-gray-100 py-16">
      <div class="max-w-4xl mx-auto px-4">
        {article.article_angle && (
          <span class="text-amber-600 text-sm font-semibold uppercase tracking-wider">{article.article_angle}</span>
        )}
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mt-2 mb-4">{article.title}</h1>
        {excerpt && (
          <p class="text-xl text-gray-600">{excerpt}</p>
        )}
      </div>
    </header>
  )}

  <!-- Chapter Timeline with Progress Bar -->
  {playbackId && fourActContent.length >= 4 && (
    <div class="bg-gray-900 py-4">
      <div class="max-w-4xl mx-auto px-4">
        <div class="flex items-center gap-2">
          <span class="text-gray-500 text-xs uppercase tracking-wider mr-2">Chapters</span>
          <div class="flex-1 flex items-center gap-1">
            {fourActContent.slice(0, 4).map((section, i) => {
              const colors = ['blue', 'purple', 'amber', 'emerald'];
              const color = colors[i] || 'gray';
              // Use section title, shortened if too long - NOT "Act I/II/III/IV"
              const chapterLabel = section.video_title || section.title?.split(':')[0]?.substring(0, 20) || `Part ${i + 1}`;
              return (
                <button onclick={`seekTo(${i * 3})`} class="chapter-marker flex-1 group">
                  <div class={`h-1 bg-${color}-500/60 rounded-full group-hover:bg-${color}-400`}></div>
                  <span class="text-xs text-gray-400 mt-1 block truncate">{chapterLabel}</span>
                </button>
              );
            })}
          </div>
        </div>
      </div>
    </div>
  )}

  <script>
    function seekTo(time) {
      const player = document.querySelector('mux-player');
      if (player) player.currentTime = time;
    }
  </script>

  <main class="max-w-4xl mx-auto px-4 py-12">
    <!-- Preamble (content before first H2) -->
    {contentSections[0] && !contentSections[0].startsWith('<h2') && (
      <div class="prose prose-lg max-w-none mb-12">
        <div set:html={contentSections[0]} />
      </div>
    )}

    <!-- Video Progress Divider - Aesthetic text breaker -->
    {playbackId && (
      <div class="my-12 flex items-center justify-center gap-3 text-xs text-gray-400 font-mono">
        <span class="w-8 h-px bg-gradient-to-r from-transparent to-gray-300"></span>
        <span class="text-blue-500">0s</span>
        <span class="w-12 h-px bg-blue-300/50"></span>
        <span class="text-purple-500">3s</span>
        <span class="w-12 h-px bg-purple-300/50"></span>
        <span class="text-amber-500">6s</span>
        <span class="w-12 h-px bg-amber-300/50"></span>
        <span class="text-emerald-500">9s</span>
        <span class="w-12 h-px bg-emerald-300/50"></span>
        <span class="text-emerald-600">12s</span>
        <span class="w-8 h-px bg-gradient-to-l from-transparent to-gray-300"></span>
      </div>
    )}

    <!-- 4-Act Sections -->
    {fourActContent.slice(0, 4).map((section, i) => {
      const actTime = actTimestamps[i];
      const sectionContent = contentSections.find(c => c.includes(section.title)) || '';
      const calloutForSection = callouts.find(c => c.placement === `after_section_${i + 1}`);
      const showTimeline = i === 0 && timeline.length > 0;  // After section 1, moved higher
      const showRelated = i === 1 && relatedArticles.length > 0;
      const useTranslucentBg = i === 3;

      return (
        <section class={`mb-16 ${useTranslucentBg ? 'relative' : ''}`}>
          {/* Translucent background for final section */}
          {useTranslucentBg && playbackId && (
            <div class="absolute inset-0 -mx-4 md:-mx-8 rounded-2xl overflow-hidden -z-10">
              <img src={getMuxThumbnail(10, 1600)} alt="" class="w-full h-full object-cover opacity-[0.06]" />
              <div class="absolute inset-0 bg-gradient-to-br from-amber-50/50 via-white/80 to-amber-50/50"></div>
            </div>
          )}

          <!-- Section Header with Video Loop -->
          {playbackId && (
            <div class="thumbnail-overlay rounded-xl mb-6">
              <video
                id={`section-video-${i}`}
                class="w-full aspect-[21/9] object-cover rounded-xl"
                autoplay
                muted
                playsinline
                loop
                preload="auto"
                poster={getMuxThumbnail(actTime.mid)}
              />
              <div class="absolute inset-0 thumbnail-gradient rounded-xl pointer-events-none"></div>
              <div class="absolute top-3 right-3">
                <span class="brand-badge text-white/80">Relocation Quest</span>
              </div>
              <div class="absolute bottom-4 left-4 right-4">
                <h2 class="text-xl md:text-2xl font-bold text-white drop-shadow-lg">{section.title}</h2>
                {section.factoid && (
                  <p class="text-white/80 text-sm mt-1 drop-shadow">{section.factoid}</p>
                )}
              </div>
            </div>
          )}

          {playbackId && (
            <script define:vars={{ videoId: `section-video-${i}`, streamUrl: getMuxStream(), startTime: actTime.start, endTime: actTime.end }}>
              (function() {
                const video = document.getElementById(videoId);
                if (!video || typeof Hls === 'undefined') return;

                let hlsReady = false;
                const hls = new Hls({ autoStartLoad: true });
                hls.loadSource(streamUrl);
                hls.attachMedia(video);

                // Try play when ready
                function tryPlay() {
                  if (hlsReady && video.paused) {
                    video.currentTime = startTime;
                    video.play().catch(() => {});
                  }
                }

                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                  hlsReady = true;
                  video.currentTime = startTime;
                  // Immediate play attempt
                  video.play().catch(() => {});
                });

                // Also try on canplay event
                video.addEventListener('canplay', tryPlay, { once: true });

                // Bounded loop within act timestamps
                video.addEventListener('timeupdate', function() {
                  if (video.currentTime >= endTime || video.currentTime < startTime) {
                    video.currentTime = startTime;
                  }
                });

                // Visibility-based play/pause with lower threshold
                const observer = new IntersectionObserver((entries) => {
                  entries.forEach(entry => {
                    if (entry.isIntersecting) {
                      tryPlay();
                    } else {
                      video.pause();
                    }
                  });
                }, { threshold: 0.2, rootMargin: '50px' });
                observer.observe(video);

                // Retry play on user interaction (mobile fix)
                document.addEventListener('click', tryPlay, { once: true });
              })();
            </script>
          )}

          <!-- Section Content -->
          {sectionContent ? (
            <div class="prose prose-lg max-w-none" set:html={sectionContent} />
          ) : (
            <div class="prose prose-lg max-w-none">
              <h2>{section.title}</h2>
            </div>
          )}

          <!-- Pull Quote (mid-section text breaker) -->
          {i === 0 && section.factoid && (
            <div class="pull-quote">
              "{section.factoid}"
            </div>
          )}

          <!-- Callout after section (if any) -->
          {calloutForSection && (
            <div class="my-8 bg-amber-50 border-l-4 border-amber-400 rounded-r-xl overflow-hidden">
              <div class="flex flex-col md:flex-row">
                {playbackId && (
                  <div class="md:w-1/3">
                    <img src={getMuxThumbnail(actTime.mid - 1, 600)} alt="" class="w-full h-48 md:h-full object-cover" />
                  </div>
                )}
                <div class={`p-6 ${playbackId ? 'md:w-2/3' : 'w-full'}`}>
                  <h3 class="text-lg font-bold text-amber-800 mb-2">
                    {calloutForSection.type === 'pro_tip' ? 'üí° ' : calloutForSection.type === 'warning' ? '‚ö†Ô∏è ' : ''}
                    {calloutForSection.title}
                  </h3>
                  <p class="text-amber-900">{calloutForSection.content}</p>
                </div>
              </div>
            </div>
          )}

          <!-- Related Articles (text breaker after section 2) -->
          {showRelated && (
            <div class="my-12 py-8 border-t border-b border-gray-100">
              <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Related Reading</h3>
              <div class="grid md:grid-cols-3 gap-4">
                {relatedArticles.map((related, ri) => {
                  const relatedThumb = related.video_playback_id
                    ? `https://image.mux.com/${related.video_playback_id}/thumbnail.jpg?time=${actTimestamps[ri % 4].mid}&width=400`
                    : null;
                  return (
                    <a href={`/${related.slug}`} class="group block bg-gray-50 rounded-lg overflow-hidden hover:bg-gray-100 transition">
                      {relatedThumb && (
                        <img src={relatedThumb} alt="" class="w-full h-24 object-cover opacity-80 group-hover:opacity-100 transition" />
                      )}
                      <div class="p-3">
                        <p class="font-medium text-gray-900 text-sm line-clamp-2 group-hover:text-amber-600 transition">{related.title}</p>
                      </div>
                    </a>
                  );
                })}
              </div>
            </div>
          )}

          <!-- Timeline (text breaker in section 3) -->
          {showTimeline && (
            <div class="my-12">
              <h3 class="text-lg font-bold text-gray-900 mb-6">Key Milestones</h3>
              <div class="relative">
                <div class="absolute left-4 top-0 bottom-0 w-0.5 bg-gradient-to-b from-amber-400 via-amber-300 to-amber-200"></div>
                <div class="space-y-6">
                  {timeline.slice(0, 4).map((event, ti) => (
                    <div class="flex items-start gap-4 pl-4">
                      <div class="w-3 h-3 bg-amber-500 rounded-full mt-1.5 -ml-[7px] ring-4 ring-white"></div>
                      <div class="flex-1 bg-gray-50 rounded-lg p-4">
                        <span class="text-amber-600 text-xs font-semibold">{event.date}</span>
                        <h4 class="font-bold text-gray-900">{event.title}</h4>
                        <p class="text-sm text-gray-600">{event.description}</p>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}

          <!-- Progress divider between sections -->
          {i < 3 && playbackId && (
            <div class="my-10 flex items-center justify-center gap-2 text-[10px] text-gray-300 font-mono">
              {actTimestamps.map((t, ti) => (
                <>
                  <span class={ti <= i ? 'text-amber-400' : 'text-gray-300'}>{t.start}s</span>
                  {ti < 3 && <span class={`w-8 h-px ${ti <= i ? 'bg-amber-300' : 'bg-gray-200'}`}></span>}
                </>
              ))}
              <span class={i >= 3 ? 'text-amber-400' : 'text-gray-300'}>12s</span>
            </div>
          )}
        </section>
      );
    })}

    <!-- Country Comparison Cards (instead of plain table) -->
    {comparison && comparison.items && comparison.items.length > 0 && (
      <section class="mb-16">
        {playbackId && (
          <div class="thumbnail-overlay rounded-xl mb-6">
            <img src={getMuxThumbnail(6, 800)} alt="" class="w-full aspect-[21/9] object-cover rounded-xl" />
            <div class="absolute inset-0 thumbnail-gradient rounded-xl"></div>
            <div class="absolute bottom-4 left-6">
              <h2 class="text-2xl md:text-3xl font-bold text-white drop-shadow-lg">{comparison.title || 'Compare Your Options'}</h2>
            </div>
          </div>
        )}

        <div class="grid md:grid-cols-2 gap-4">
          {comparison.items.map((item, i) => {
            const flag = getCountryFlag(item.name);
            const isFeatured = i === 0;
            return (
              <div class={`country-card rounded-xl p-5 ${isFeatured ? 'featured md:col-span-2' : ''}`}>
                <div class="flex items-start gap-4">
                  <span class="text-4xl">{flag}</span>
                  <div class="flex-1">
                    <h3 class={`font-bold ${isFeatured ? 'text-xl text-amber-900' : 'text-lg text-gray-900'}`}>{item.name}</h3>
                    <div class="mt-3 grid grid-cols-2 gap-3 text-sm">
                      {Object.entries(item).filter(([k]) => k !== 'name').map(([key, value]) => (
                        <div>
                          <span class="text-gray-500 text-xs uppercase tracking-wider">{key.replace(/_/g, ' ')}</span>
                          <p class={`font-medium ${isFeatured ? 'text-amber-800' : 'text-gray-900'}`}>{value}</p>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      </section>
    )}

    <!-- Stat Highlight (if present) -->
    {statHighlight && (
      <section class="mb-16 -mx-4 md:-mx-8 lg:-mx-16">
        <div class="relative py-16 px-8 overflow-hidden">
          {playbackId && (
            <div class="absolute inset-0">
              <img src={getMuxThumbnail(10, 1600)} alt="" class="w-full h-full object-cover opacity-[0.12]" />
              <div class="absolute inset-0 bg-gradient-to-r from-amber-50 via-white/90 to-amber-50"></div>
            </div>
          )}
          <div class="relative max-w-3xl mx-auto text-center">
            <span class="text-amber-600 text-sm font-semibold uppercase tracking-wider">Key Takeaway</span>
            <p class="text-3xl md:text-4xl font-bold text-gray-900 mt-4 mb-6" set:html={statHighlight.headline} />
            {statHighlight.stats && (
              <div class="flex justify-center gap-8 mt-8">
                {statHighlight.stats.map(stat => (
                  <div class="text-center">
                    <div class="text-4xl font-bold text-amber-600">{stat.value}</div>
                    <div class="text-sm text-gray-500 mt-1">{stat.label}</div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      </section>
    )}

    <!-- FAQ Section (if present) -->
    {faq && faq.length > 0 && (
      <section class="mb-16">
        <h2 class="text-3xl font-bold text-gray-900 mb-8">Frequently Asked Questions</h2>
        <div class="grid md:grid-cols-2 gap-6">
          {faq.map((item, i) => {
            const thumbTime = actTimestamps[i % 4]?.mid || 1.5;
            return (
              <div class="bg-gray-50 rounded-xl overflow-hidden">
                {playbackId && (
                  <img src={getMuxThumbnail(thumbTime, 400)} alt="" class="w-full h-32 object-cover opacity-60" />
                )}
                <div class={`p-6 ${playbackId ? '-mt-8' : ''} relative`}>
                  <div class="bg-white rounded-lg shadow-lg p-4">
                    <h3 class="font-bold text-gray-900 mb-2">{item.q}</h3>
                    <p class="text-gray-600 text-sm">{item.a}</p>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      </section>
    )}

    <!-- Sources Section (if present) -->
    {sources && sources.length > 0 && (
      <section class="relative rounded-xl overflow-hidden mb-12">
        {playbackId && (
          <div class="absolute inset-0">
            <img src={getMuxThumbnail(10.5, 800)} alt="" class="w-full h-full object-cover opacity-10" />
            <div class="absolute inset-0 bg-gradient-to-br from-gray-50 via-white/90 to-gray-50"></div>
          </div>
        )}
        <div class="relative p-8">
          <h3 class="font-semibold text-gray-900 mb-4">Sources & References</h3>
          <div class="grid md:grid-cols-3 gap-4">
            {sources.map((source, i) => {
              const thumbTime = actTimestamps[i % 4]?.mid || 1.5;
              return (
                <a href={source.url} target="_blank" rel="noopener" class="flex items-center gap-3 p-3 bg-white/60 rounded-lg hover:bg-white transition">
                  {playbackId && (
                    <img src={getMuxThumbnail(thumbTime, 400)} alt="" class="w-12 h-12 object-cover rounded" />
                  )}
                  <div>
                    <p class="text-sm font-medium text-gray-900">{source.name}</p>
                    {source.description && (
                      <p class="text-xs text-gray-500">{source.description}</p>
                    )}
                  </div>
                </a>
              );
            })}
          </div>
        </div>
      </section>
    )}

    <!-- Article Footer -->
    <footer class="pt-8 border-t">
      <div class="flex items-center gap-4">
        {playbackId && (
          <img src={getMuxThumbnail(10.5, 800)} alt="" class="w-16 h-16 object-cover rounded-full border-2 border-amber-200" />
        )}
        <div>
          <p class="text-sm font-medium text-gray-900">Relocation Quest Editorial Team</p>
          <p class="text-xs text-gray-500">
            Published {new Date(article.published_at || article.created_at).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })} ‚Ä¢ {article.word_count} words
          </p>
        </div>
      </div>
      <div class="mt-6">
        <a href="/" class="inline-flex items-center text-amber-600 hover:text-amber-800 font-medium">
          ‚Üê Back to articles
        </a>
      </div>
    </footer>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-900 text-white py-12 mt-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <p class="text-gray-400">¬© {new Date().getFullYear()} Relocation Quest. All rights reserved.</p>
    </div>
  </footer>

  <!-- Currency Conversion Script - USD-led with local currency -->
  <script>
    (async function convertCurrency() {
      // Try to get exchange rates (cache for 1 hour)
      const cacheKey = 'rq_exchange_rates';
      const cacheTime = 'rq_exchange_time';
      let rates = null;

      try {
        const cached = localStorage.getItem(cacheKey);
        const cachedTime = localStorage.getItem(cacheTime);
        const oneHour = 3600000;

        if (cached && cachedTime && (Date.now() - parseInt(cachedTime)) < oneHour) {
          rates = JSON.parse(cached);
        } else {
          const res = await fetch('https://v6.exchangerate-api.com/v6/open/latest/USD');
          const data = await res.json();
          if (data.rates) {
            rates = data.rates;
            localStorage.setItem(cacheKey, JSON.stringify(rates));
            localStorage.setItem(cacheTime, Date.now().toString());
          }
        }
      } catch (e) {
        console.log('Currency conversion unavailable');
        return;
      }

      if (!rates) return;

      // Find all prose sections and convert currencies
      const proseElements = document.querySelectorAll('.prose');

      // Currency patterns to detect (euro-centric content)
      const euroPattern = /‚Ç¨\s*([\d,]+(?:\.\d{2})?)/g;

      proseElements.forEach(prose => {
        const walker = document.createTreeWalker(prose, NodeFilter.SHOW_TEXT, null, false);
        const nodesToUpdate = [];

        while (walker.nextNode()) {
          const node = walker.currentNode;
          if (euroPattern.test(node.textContent)) {
            nodesToUpdate.push(node);
          }
          euroPattern.lastIndex = 0;
        }

        nodesToUpdate.forEach(node => {
          const text = node.textContent;
          const newText = text.replace(euroPattern, (match, amount) => {
            const euroValue = parseFloat(amount.replace(/,/g, ''));
            const eurRate = rates.EUR || 0.92;
            const usdValue = euroValue / eurRate;

            // Format USD as primary
            const usdFormatted = new Intl.NumberFormat('en-US', {
              style: 'currency',
              currency: 'USD',
              minimumFractionDigits: 0,
              maximumFractionDigits: 0
            }).format(usdValue);

            // Keep EUR as local reference
            const eurFormatted = new Intl.NumberFormat('de-DE', {
              style: 'currency',
              currency: 'EUR',
              minimumFractionDigits: 0,
              maximumFractionDigits: 0
            }).format(euroValue);

            return `${usdFormatted} (${eurFormatted})`;
          });

          if (newText !== text) {
            node.textContent = newText;
          }
        });
      });
    })();
  </script>
</body>
</html>
