---
/**
 * Country Hub Template - Conde Nast Style
 * =======================================
 *
 * DATA SOURCE: Neon PostgreSQL (country_hubs table)
 * GENERATED BY: content-worker Phase D (Hub Creation)
 *
 * Hub pages are comprehensive pillar pages that aggregate all cluster content:
 * - Story, Guide, YOLO, Voices modes
 * - Topic cluster articles
 * - SEO-optimized slugs (up to 12 keywords)
 *
 * Design matches the article template for visual consistency.
 */
import { sql } from '../../lib/db';

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/guides');
}

// Fetch the hub with aggregated content
const hubResult = await sql`
  SELECT
    h.id,
    h.country_code,
    h.cluster_id,
    h.location_type,
    h.location_name,
    h.slug,
    h.legacy_slug,
    h.title,
    h.meta_description,
    h.hub_content,
    h.payload,
    h.seo_data,
    h.primary_keyword,
    h.keyword_volume,
    h.video_playback_id,
    h.video_thumbnail_url,
    h.status,
    h.published_at,
    h.created_at,
    h.updated_at
  FROM country_hubs h
  WHERE h.slug = ${slug}
    AND h.status = 'published'
  LIMIT 1
`;

const hub = hubResult[0];

if (!hub) {
  return Astro.redirect('/guides');
}

// Fetch country data for additional context
const countryResult = await sql`
  SELECT
    id, name, slug, code, flag_emoji, region, continent, capital,
    language, currency_code, relocation_motivations, facts,
    visa_types, tax_overview
  FROM countries
  WHERE code = ${hub.country_code}
  LIMIT 1
`;
const country = countryResult[0];

// Fetch CORE cluster articles (Story/Guide/YOLO/Voices) - each has its OWN video
const clusterResult = await sql`
  SELECT
    id, slug, title, meta_description, article_mode, video_playback_id, is_primary,
    video_narrative, payload
  FROM articles
  WHERE cluster_id = ${hub.cluster_id}
    AND app = 'relocation'
    AND published_at IS NOT NULL
    AND article_mode IN ('story', 'guide', 'yolo', 'voices')
  ORDER BY
    CASE article_mode
      WHEN 'story' THEN 1
      WHEN 'guide' THEN 2
      WHEN 'yolo' THEN 3
      WHEN 'voices' THEN 4
    END
`;
const clusterArticles = clusterResult || [];

// Log video IDs for debugging
console.log('Cluster articles with videos:', clusterArticles.map((a: any) => ({
  mode: a.article_mode,
  video: a.video_playback_id?.substring(0, 20) + '...'
})));

// Fetch topic cluster articles (child articles linked to this hub's parent)
const topicClusterResult = await sql`
  SELECT
    id, slug, title, meta_description, video_playback_id
  FROM articles
  WHERE parent_id IN (SELECT id FROM articles WHERE cluster_id = ${hub.cluster_id} AND is_primary = true)
    AND app = 'relocation'
    AND published_at IS NOT NULL
  ORDER BY created_at DESC
  LIMIT 12
`;
const topicArticles = topicClusterResult || [];

// Parse hub payload
let hubPayload: any = {};
try {
  hubPayload = typeof hub.payload === 'string' ? JSON.parse(hub.payload) : (hub.payload || {});
} catch (e) {
  console.error('Failed to parse hub payload:', e);
}

// Parse country facts
let facts: Record<string, string> = {};
try {
  facts = typeof country?.facts === 'string' ? JSON.parse(country.facts) : (country?.facts || {});
} catch (e) {}

// Parse SEO data
let seoData: any = {};
try {
  seoData = typeof hub.seo_data === 'string' ? JSON.parse(hub.seo_data) : (hub.seo_data || {});
} catch (e) {}

// Quick stats from country facts
const quickStats = [
  { label: 'Corporate Tax', value: facts.corporate_tax_rate, icon: 'üíº' },
  { label: 'DN Visa Cost', value: facts.dn_visa_cost, icon: 'üíª' },
  { label: 'Cost of Living', value: facts.cost_of_living_single, icon: 'üè†' },
  { label: 'Climate', value: facts.climate, icon: '‚òÄÔ∏è' },
].filter(s => s.value && s.value !== 'N/A');

// Playback ID from hub or primary article
const playbackId = hub.video_playback_id || clusterArticles.find((a: any) => a.is_primary)?.video_playback_id;

// Mux helpers
function getMuxThumbnail(id: string, time: number = 5, width: number = 800) {
  if (!id) return '';
  return `https://image.mux.com/${id}/thumbnail.jpg?time=${time}&width=${width}`;
}

// Mode config for display
const modeConfig: Record<string, { label: string; icon: string; color: string; desc: string }> = {
  'story': { label: 'Story', icon: 'üìñ', color: 'amber', desc: 'Narrative journey' },
  'guide': { label: 'Guide', icon: 'üìã', color: 'blue', desc: 'Step-by-step practical guide' },
  'yolo': { label: 'YOLO', icon: 'üöÄ', color: 'pink', desc: 'Adventure-focused' },
  'voices': { label: 'Voices', icon: 'üí¨', color: 'purple', desc: 'Real expat experiences' },
};

// Canonical URL
const canonicalUrl = `https://relocation.quest/hubs/${hub.slug}`;
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{hub.title} | Relocation Quest</title>
  <meta name="description" content={hub.meta_description || `Complete ${hub.location_name} relocation guide with visa, tax, and cost of living information.`}>
  <link rel="canonical" href={canonicalUrl}>

  <!-- Open Graph -->
  <meta property="og:title" content={hub.title}>
  <meta property="og:description" content={hub.meta_description}>
  <meta property="og:type" content="article">
  <meta property="og:url" content={canonicalUrl}>
  {playbackId && <meta property="og:image" content={getMuxThumbnail(playbackId, 5, 1200)}>}

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Video Players -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://unpkg.com/@mux/mux-player"></script>

  <style>
    body { font-family: 'Inter', sans-serif; }

    /* Conde Nast-style typography */
    .prose h2 { font-size: 1.875rem; font-weight: 700; margin-top: 3rem; margin-bottom: 1rem; }
    .prose h3 { font-size: 1.5rem; font-weight: 600; margin-top: 2rem; margin-bottom: 0.75rem; }
    .prose p { font-size: 1.125rem; line-height: 1.8; margin-bottom: 1.5rem; color: #374151; }
    .prose ul, .prose ol { margin-bottom: 1.5rem; padding-left: 1.5rem; }
    .prose li { font-size: 1.125rem; line-height: 1.75; margin-bottom: 0.5rem; }
    .prose blockquote { border-left: 4px solid #f59e0b; padding-left: 1.5rem; margin: 2rem 0; font-style: italic; }
    .prose a { color: #d97706; text-decoration: underline; }
    .prose a:hover { color: #b45309; }
    .prose table { width: 100%; border-collapse: collapse; margin: 2rem 0; }
    .prose th, .prose td { padding: 0.75rem 1rem; border: 1px solid #e5e7eb; text-align: left; }
    .prose th { background: #f9fafb; font-weight: 600; }

    /* Callout boxes for nationality-specific info */
    .nationality-callout {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-left: 4px solid #f59e0b;
      padding: 1rem 1.5rem;
      margin: 1.5rem 0;
      border-radius: 0.5rem;
    }

    /* Article cards */
    .article-card {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .article-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px -12px rgba(0,0,0,0.15);
    }
  </style>
</head>

<body class="bg-white">
  <!-- Navigation -->
  <nav class="bg-white/95 backdrop-blur-md border-b border-gray-100 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <a href="/" class="text-xl font-bold">
          <span class="text-gray-900">Relocation</span><span class="text-amber-500">Quest</span>
        </a>
        <div class="flex items-center space-x-6">
          <a href="/" class="text-gray-600 hover:text-gray-900 font-medium">Home</a>
          <a href="/guides" class="text-amber-600 font-semibold">Guides</a>
          <a href="/articles" class="text-gray-600 hover:text-gray-900 font-medium">Articles</a>
          <a href="/companies" class="text-gray-600 hover:text-gray-900 font-medium">Companies</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Hero Section with Video -->
  {playbackId ? (
    <header class="relative bg-gray-900">
      <div class="max-w-6xl mx-auto">
        <mux-player
          playback-id={playbackId}
          accent-color="#f59e0b"
          autoplay="muted"
          loop
          class="w-full aspect-video"
        />
      </div>
      <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 via-black/60 to-transparent p-8">
        <div class="max-w-4xl mx-auto">
          <!-- Breadcrumb -->
          <div class="flex items-center space-x-2 text-gray-400 text-sm mb-4">
            <a href="/" class="hover:text-white">Home</a>
            <span>‚Ä∫</span>
            <a href="/guides" class="hover:text-white">Guides</a>
            <span>‚Ä∫</span>
            <span class="text-white">{hub.location_name}</span>
          </div>
          <div class="flex items-center gap-4 mb-4">
            <span class="text-6xl">{country?.flag_emoji || 'üåç'}</span>
            <div>
              <h1 class="text-3xl md:text-5xl font-bold text-white">{hub.title}</h1>
              {country && (
                <p class="text-xl text-gray-300 mt-2">{country.region} ‚Ä¢ {country.capital} ‚Ä¢ {country.currency_code}</p>
              )}
            </div>
          </div>
          <!-- SEO Keywords Badge -->
          {hub.primary_keyword && (
            <div class="flex items-center gap-2 mt-4">
              <span class="bg-amber-500/20 text-amber-300 px-3 py-1 rounded-full text-sm">
                üîç {hub.primary_keyword}
              </span>
              {hub.keyword_volume && (
                <span class="text-gray-400 text-sm">~{hub.keyword_volume.toLocaleString()} monthly searches</span>
              )}
            </div>
          )}
        </div>
      </div>
    </header>
  ) : (
    <header class="bg-gradient-to-r from-amber-500 to-orange-500 text-white py-16">
      <div class="max-w-4xl mx-auto px-4">
        <div class="flex items-center space-x-2 text-white/70 text-sm mb-6">
          <a href="/" class="hover:text-white">Home</a>
          <span>‚Ä∫</span>
          <a href="/guides" class="hover:text-white">Guides</a>
          <span>‚Ä∫</span>
          <span class="text-white">{hub.location_name}</span>
        </div>
        <div class="flex items-center gap-6">
          <span class="text-7xl">{country?.flag_emoji || 'üåç'}</span>
          <div>
            <h1 class="text-4xl md:text-5xl font-bold">{hub.title}</h1>
            {country && (
              <p class="text-xl text-white/80 mt-2">{country.region} ‚Ä¢ {country.capital}</p>
            )}
          </div>
        </div>
      </div>
    </header>
  )}

  <!-- Quick Stats Bar -->
  {quickStats.length > 0 && (
    <section class="bg-gradient-to-r from-amber-500 to-orange-500 py-6">
      <div class="max-w-5xl mx-auto px-4">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          {quickStats.map((stat) => (
            <div class="bg-white/20 backdrop-blur-sm rounded-xl p-4 text-center">
              <span class="text-2xl">{stat.icon}</span>
              <div class="text-white/80 text-sm mt-1">{stat.label}</div>
              <div class="text-white font-bold text-lg">{stat.value}</div>
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Cluster Articles Navigation - Each with its OWN unique video -->
  {clusterArticles.length > 0 && (
    <section class="bg-gray-50 border-b border-gray-200 py-8">
      <div class="max-w-5xl mx-auto px-4">
        <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Explore {hub.location_name} - 4 Perspectives</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          {clusterArticles.map((article: any, index: number) => {
            const config = modeConfig[article.article_mode] || modeConfig.story;
            // Use different act timestamps for visual variety (Act 1, 2, 3, 4)
            const actTimes = [1.5, 4.5, 7.5, 10.5];
            const thumbTime = actTimes[index % 4];
            return (
              <a
                href={`/${article.slug}`}
                class="article-card bg-white rounded-xl overflow-hidden shadow-sm border border-gray-100"
              >
                {article.video_playback_id && (
                  <div class="relative">
                    <img
                      src={getMuxThumbnail(article.video_playback_id, thumbTime, 400)}
                      alt={article.title}
                      class="w-full aspect-video object-cover"
                    />
                    <div class={`absolute top-2 right-2 bg-${config.color}-500 text-white text-xs px-2 py-1 rounded-full font-semibold`}>
                      {config.icon} {config.label}
                    </div>
                  </div>
                )}
                <div class="p-4">
                  <h3 class="font-semibold text-gray-900 text-sm line-clamp-2">{article.title}</h3>
                  <p class="text-xs text-gray-500 mt-1">{config.desc}</p>
                </div>
              </a>
            );
          })}
        </div>
        <!-- Video attribution -->
        <p class="text-xs text-gray-400 mt-4 text-center">
          Each perspective has its own unique video journey
        </p>
      </div>
    </section>
  )}

  <!-- 4-Act Story Timeline (from Story video) -->
  {clusterArticles.find((a: any) => a.article_mode === 'story')?.video_playback_id && (
    <section class="bg-gray-900 py-8">
      <div class="max-w-5xl mx-auto px-4">
        <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-6 text-center">
          The {hub.location_name} Story - 4 Acts
        </h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          {[
            { act: 1, title: 'The Draw', time: 1.5, desc: 'What calls people here' },
            { act: 2, title: 'The Opportunity', time: 4.5, desc: 'Business & lifestyle' },
            { act: 3, title: 'The Journey', time: 7.5, desc: 'Making the move' },
            { act: 4, title: 'The New Life', time: 10.5, desc: 'Living the dream' }
          ].map((act) => {
            const storyVideo = clusterArticles.find((a: any) => a.article_mode === 'story')?.video_playback_id;
            return (
              <div class="bg-gray-800 rounded-xl overflow-hidden">
                <img
                  src={getMuxThumbnail(storyVideo, act.time, 400)}
                  alt={act.title}
                  class="w-full aspect-video object-cover"
                />
                <div class="p-3">
                  <span class="text-amber-500 text-xs font-bold">ACT {act.act}</span>
                  <h4 class="text-white font-semibold text-sm">{act.title}</h4>
                  <p class="text-gray-400 text-xs mt-1">{act.desc}</p>
                </div>
              </div>
            );
          })}
        </div>
      </div>
    </section>
  )}

  <!-- Main Hub Content -->
  <main class="max-w-4xl mx-auto px-4 py-12">
    <!-- Hub Content (generated HTML) -->
    {hub.hub_content && (
      <div class="prose max-w-none" set:html={hub.hub_content} />
    )}

    <!-- Topic Cluster Articles -->
    {topicArticles.length > 0 && (
      <section class="mt-16 pt-8 border-t border-gray-200">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Deep Dive Articles</h2>
        <p class="text-gray-600 mb-8">Detailed guides on specific topics for {hub.location_name}.</p>
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {topicArticles.map((article: any) => (
            <a
              href={`/${article.slug}`}
              class="article-card bg-white rounded-xl overflow-hidden shadow-sm border border-gray-100"
            >
              {article.video_playback_id && (
                <img
                  src={getMuxThumbnail(article.video_playback_id, 5, 400)}
                  alt={article.title}
                  class="w-full aspect-video object-cover"
                />
              )}
              <div class="p-4">
                <h3 class="font-semibold text-gray-900 line-clamp-2">{article.title}</h3>
                {article.meta_description && (
                  <p class="text-sm text-gray-600 mt-2 line-clamp-2">{article.meta_description}</p>
                )}
              </div>
            </a>
          ))}
        </div>
      </section>
    )}
  </main>

  <!-- CTA Section -->
  <section class="bg-gradient-to-r from-amber-500 to-orange-500 py-16">
    <div class="max-w-4xl mx-auto px-4 text-center">
      <h2 class="text-3xl md:text-4xl font-bold text-white mb-4">
        Ready to Make {hub.location_name} Home?
      </h2>
      <p class="text-xl text-white/90 mb-8">
        Get expert help with your relocation journey.
      </p>
      <div class="flex flex-wrap justify-center gap-4">
        <a href="/companies" class="bg-white text-amber-600 px-8 py-3 rounded-full font-semibold hover:bg-amber-50 transition-colors shadow-lg">
          Find Relocation Services
        </a>
        <a href="/guides" class="bg-transparent text-white border-2 border-white px-8 py-3 rounded-full font-semibold hover:bg-white/10 transition-colors">
          Explore More Countries
        </a>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="bg-gray-900 text-white py-16">
    <div class="max-w-7xl mx-auto px-4">
      <div class="grid md:grid-cols-4 gap-8 mb-12">
        <div>
          <h3 class="font-bold text-xl mb-4">
            Relocation<span class="text-amber-500">Quest</span>
          </h3>
          <p class="text-gray-400 text-sm">
            Comprehensive guides for relocating abroad. Making your move easier.
          </p>
        </div>
        <div>
          <h4 class="font-semibold mb-4">Popular Guides</h4>
          <ul class="space-y-2 text-gray-400 text-sm">
            <li><a href="/guides/cyprus" class="hover:text-amber-400">üá®üáæ Cyprus</a></li>
            <li><a href="/guides/portugal" class="hover:text-amber-400">üáµüáπ Portugal</a></li>
            <li><a href="/guides/thailand" class="hover:text-amber-400">üáπüá≠ Thailand</a></li>
            <li><a href="/guides/united-arab-emirates" class="hover:text-amber-400">üá¶üá™ UAE</a></li>
          </ul>
        </div>
        <div>
          <h4 class="font-semibold mb-4">By Motivation</h4>
          <ul class="space-y-2 text-gray-400 text-sm">
            <li><a href="/guides?motivation=digital-nomad" class="hover:text-amber-400">üíª Digital Nomad</a></li>
            <li><a href="/guides?motivation=corporate" class="hover:text-amber-400">üíº Corporate</a></li>
            <li><a href="/guides?motivation=retirement" class="hover:text-amber-400">üåÖ Retirement</a></li>
            <li><a href="/guides?motivation=wealth" class="hover:text-amber-400">üíé Wealth</a></li>
          </ul>
        </div>
        <div>
          <h4 class="font-semibold mb-4">Resources</h4>
          <ul class="space-y-2 text-gray-400 text-sm">
            <li><a href="/articles" class="hover:text-amber-400">All Articles</a></li>
            <li><a href="/companies" class="hover:text-amber-400">Service Directory</a></li>
          </ul>
        </div>
      </div>
      <div class="border-t border-gray-800 pt-8 text-center">
        <p class="text-gray-500 text-sm">
          ¬© 2024 Relocation Quest. All rights reserved.
        </p>
        <p class="text-gray-600 text-xs mt-2">
          Last updated: {hub.updated_at ? new Date(hub.updated_at).toLocaleDateString() : 'Recently'}
        </p>
      </div>
    </div>
  </footer>
</body>
</html>
